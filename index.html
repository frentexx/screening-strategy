<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡å­¸è³‡æ–™ç¯©é¸ç­–ç•¥</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ SheetJS (xlsx) å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- æ›´æ–° Firebase SDK (åŒ…å« Google Auth) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js"></script>

    <!-- 
      è¼‰å…¥å­—é«”ï¼š
      1. Poppins (åœ“è§’æ„Ÿ, ç”¨æ–¼æ¨™é¡Œå’ŒæŒ‰éˆ•)
      2. Noto Sans TC (ç¹é«”ä¸­æ–‡å‚™æ´)
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ğŸ¨ é’æ˜¥ç§‘æŠ€æ„Ÿ UI é¢¨æ ¼ ğŸ¨ --- */

        /* 1. æ•´é«”å­—é«”è¨­å®š */
        body {
            /* å„ªå…ˆä½¿ç”¨ Poppinsï¼Œå‚™æ´ä½¿ç”¨ Noto Sans TC */
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: #F7F9FB; /* æ·ºç°èƒŒæ™¯ */
            color: #1F2937; /* é è¨­æ·±è‰²æ–‡å­— */
        }
        h1, h2, h3, button, .font-heading {
             font-family: 'Poppins', 'Noto Sans TC', sans-serif;
        }

        /* 2. è‡ªè¨‚æ¼¸å±¤æŒ‰éˆ• (ä¸Šå‚³ / å¥—ç”¨ç¯©é¸) */
        .btn-upload {
            background: linear-gradient(90deg, #3DB2FF 0%, #00D1A0 100%);
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(61,178,255,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 1rem 1.75rem; 
            font-weight: 600;
        }
        .btn-upload:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(61,178,255,0.4);
        }
        
        /* 3. è‡ªè¨‚æ¼¸å±¤æŒ‰éˆ• (æ–°å¢æ¢ä»¶ / åŒ¯å‡º) */
        .btn-add {
            background: linear-gradient(90deg, #00C2FF 0%, #00E676 100%);
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0,200,200,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        .btn-add:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,200,200,0.4);
        }
        
        /* 4. è‡ªè¨‚æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• (ç¹¼æ‰¿ .btn-upload) */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            font-size: 100px;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* 5. è‡ªè¨‚è¡¨å–®æ¨£å¼ (ä¸‹æ‹‰é¸å–®/è¼¸å…¥æ¡†) */
        .form-input-style {
            border-radius: 12px !important;
            border: 1px solid #E0E0E0 !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important;
            background-color: white !important;
            color: #111827 !important;
            padding-top: 0.6rem; /* å¢åŠ ä¸€é»å…§è· */
            padding-bottom: 0.6rem;
            transition: all 0.3s ease;
        }
        .form-input-style:focus {
            border-color: #3DB2FF !important;
            box-shadow: 0 0 0 3px rgba(61,178,255,0.2) !important;
            outline: none !important;
        }
        .form-input-style:disabled {
            background-color: #F3F4F6 !important; /* gray-100 */
            color: #9CA3AF !important; /* gray-400 */
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }


        /* 6. è‡ªè¨‚æ»¾å‹•æ¢ (ç¾åŒ–) */
        #results-output::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #results-output::-webkit-scrollbar-track {
            background: #F3F4F6; /* gray-100 */
            border-radius: 10px;
        }
        #results-output::-webkit-scrollbar-thumb {
            background: #CBD5E1; /* gray-300 */
            border-radius: 10px;
        }
        #results-output::-webkit-scrollbar-thumb:hover {
            background: #94A3B8; /* gray-400 */
        }

        /* 7. è¡¨æ ¼æ¨£å¼ */
        table {
            border-spacing: 0;
            min-width: 100%;
        }
        th, td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
            white-space: nowrap;
        }
        th {
            background-color: #E6F4FF; /* äº®è—è‰²èƒŒæ™¯ */
            color: #005A9C; /* æ·±è—è‰²æ–‡å­— */
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #F9FAFB; /* æ·ºç° (gray-50) */
        }
        tr:hover {
            background-color: #E0F2FE; /* äº®è— (blue-100) */
        }

        /* ç¯©é¸æ¢ä»¶çµ„å‹•ç•« */
        .filter-group {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        .filter-group-enter {
            opacity: 0;
            max-height: 0px;
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .filter-group-exit {
            opacity: 0;
            max-height: 0px;
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        /* éš±è—è¼”åŠ© class */
        .hidden-strict {
            display: none !important;
        }

        /* è¨è«–å€æ¨£å¼ */
        .post-item {
            border: 1px solid #E5E7EB; /* gray-200 */
            border-radius: 12px;
            padding: 1rem 1.5rem;
            background-color: #FFFFFF;
            transition: all 0.3s ease;
        }
        .post-item:hover {
            border-color: #3DB2FF;
            box-shadow: 0 4px 10px rgba(61,178,255,0.1);
        }
        .post-title-link {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
            color: #1E40AF; /* blue-800 */
            cursor: pointer;
        }
        .post-title-link:hover {
            text-decoration: underline;
        }
        .post-meta {
            font-size: 0.875rem; /* text-sm */
            color: #6B7280; /* gray-500 */
        }
        /* æ¨™ç±¤æ¨£å¼ */
        .post-tag {
            display: inline-block;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px; /* rounded-full */
            margin-right: 0.5rem;
            margin-bottom: 0.25rem; /* æ›è¡Œé–“è· */
        }
        .tag-category { background-color: #E0E7FF; color: #3730A3; } /* indigo */
        .tag-linked { background-color: #D1FAE5; color: #065F46; } /* green */
        
        .reply-item {
            border-top: 1px solid #E5E7EB; /* gray-200 */
            padding-top: 1.25rem;
            padding-bottom: 1.25rem;
        }
        .reply-item:first-child {
            border-top: none;
        }
        
        /* ç°¡å–®çš„ Markdown æ›è¡Œæ¨£å¼ */
        .post-content {
            white-space: pre-wrap; /* ä¿æŒæ›è¡Œå’Œç©ºæ ¼ */
            word-wrap: break-word; /* é•·å–®å­—æ›è¡Œ */
        }

        /* é–‹é—œ Toggle Switch æ¨£å¼ */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        
    </style>
</head>
<body class="bg-gray-50">

    <!-- ç™»å…¥å®¹å™¨ -->
    <div id="login-container" class="container mx-auto p-4 md:p-8 max-w-md mt-10 md:mt-16">
        
        <!-- ç¶²ç«™æ¨™é¡Œ -->
        <div class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">å°æ¸…è¯åŸæ°‘ç­</h1>
            <h2 class="text-xl md:text-2xl font-semibold text-gray-700">å¿—é¡˜é¸å¡«è¼”åŠ©ç¶²ç«™</h2>
        </div>

        <main class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
            <p class="text-center text-gray-700 font-medium mb-2">è«‹ä½¿ç”¨ @ppsh.ptc.edu.tw ç¶²åŸŸå¸³è™Ÿç™»å…¥</p>
            <!-- ä½¿ç”¨ç¯„åœèªªæ˜ -->
            <p class="text-center text-gray-500 text-sm mb-6">
                æœ¬ç¶²ç«™åƒ…ä¾›å°æ¸…è¯åŸæ°‘ç­å¸«ç”Ÿä½¿ç”¨ï¼Œ<br>éå±åŒ—é«˜ä¸­ç¶²åŸŸå¸³è™Ÿç„¡æ³•ç™»å…¥ã€‚
            </p>
            <div class="space-y-4">
                <!-- Google ç™»å…¥æŒ‰éˆ• -->
                <button id="google-login-btn" class="btn-upload w-full !rounded-xl flex items-center justify-center gap-3">
                    <svg class="w-6 h-6 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C39.756 34.927 44 28.159 44 20c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    <!-- span å’Œ nowrap ç¢ºä¿åŒä¸€è¡Œ -->
                    <span class="whitespace-nowrap">
                        ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                        <span class="text-xs opacity-80">ï¼ˆé™æœ¬æ ¡å¸³è™Ÿï¼‰</span>
                    </span>
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-2 h-4 text-center"></p>
            </div>
        </main>
    </div>

    <!-- ä¸»è¦æ‡‰ç”¨å®¹å™¨ï¼Œé è¨­éš±è— -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        
        <!-- æ¨™é¡Œï¼ŒåŠ å…¥ relative å’Œç™»å‡ºæŒ‰éˆ• -->
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">å‡å­¸è³‡æ–™ç¯©é¸ç­–ç•¥</h1>
            <p id="user-display" class="text-gray-600 mt-1"></p>
            <button id="logout-btn" class="absolute top-0 right-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-xl transition duration-300">ç™»å‡º</button>
        </header>

        <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼è¦–åœ– (åŒ…å«ç¯©é¸å™¨å’Œè«–å£‡åˆ—è¡¨) -->
        <main id="main-app-view" class="bg-white shadow-xl rounded-2xl p-6 md:p-8">

            <!-- æª”æ¡ˆä¸Šå‚³å€ (åƒ…é™ç®¡ç†è€…) -->
            <section id="upload-section" class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">1. ç®¡ç†å“¡åŠŸèƒ½</h2>
                <!-- æ”¹ç‚ºç™½åº• + æ·¡è—é‚Šæ¡† -->
                <div class="flex flex-col items-center p-6 bg-white border-2 border-dashed border-blue-200 rounded-2xl gap-4">
                    <!-- ä¸Šå‚³æª”æ¡ˆ -->
                    <div class="w-full text-center">
                        <label class="file-input-wrapper btn-upload" for="file-input">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            <span class="align-middle">æ›´æ–°è³‡æ–™åº« (.xlsx)</span>
                            <input type="file" id="file-input" accept=".xlsx, .csv" class="hidden">
                        </label>
                        <p id="file-name" class="mt-2 text-sm text-gray-500">æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ</p>
                    </div>

                    <!-- ç•™è¨€æ¿é–‹é—œ -->
                    <div class="w-full border-t pt-4 flex items-center justify-center gap-3">
                        <span class="font-medium text-gray-700">ç•™è¨€æ¿åŠŸèƒ½ï¼š</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="forum-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                            <label for="forum-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <span id="forum-status-text" class="text-sm font-bold text-gray-500">å·²é—œé–‰</span>
                    </div>
                </div>
            </section>

            <!-- ğŸ“˜ æ–°å¢ï¼šç¯©é¸ç­–ç•¥æ•™å­¸æŒ‡å— -->
            <section class="mb-6 bg-white rounded-2xl shadow-md border-l-4 border-yellow-400 overflow-hidden">
                <details class="group" open> <!-- open å±¬æ€§è®“å®ƒé è¨­å±•é–‹ï¼Œè‹¥æƒ³é è¨­æ”¶åˆè«‹ç§»é™¤ open -->
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-5 bg-yellow-50 hover:bg-yellow-100 transition-colors">
                        <span class="flex items-center text-lg text-yellow-800 font-bold">
                            ğŸ’¡ ç¯©é¸ç­–ç•¥æ•™å­¸æŒ‡å— (é»æ“Šæ”¶åˆ/å±•é–‹)
                        </span>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-gray-700 p-5 pt-2 text-sm md:text-base space-y-4">
                        
                        <!-- å…è²¬è²æ˜ -->
                        <div class="p-3 bg-red-50 text-red-700 rounded-lg border border-red-100 flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                            <p class="font-bold">æ³¨æ„ï¼šä»¥ä¸‹é‡å°ã€Œå¤§å­¸å€‹äººç”³è«‹-åŸä½æ°‘å¤–åŠ ã€æä¾›ç¯©é¸ç­–ç•¥å»ºè­°ï¼Œä¸ä¿è­‰ä¸€å®šä¸Šæ¦œï¼Œåƒ…ä¾›é¸å¡«å¿—é¡˜åƒè€ƒã€‚</p>
                        </div>

                        <!-- æ ¸å¿ƒæ¦‚å¿µ -->
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <h4 class="font-bold text-blue-800 mb-2">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</h4>
                            <p class="text-blue-900 leading-relaxed">
                                ä¸€èˆ¬ç”Ÿé€šéç¬¬ 1 éšæ®µçš„äººæ•¸å¹¾ä¹æ˜¯æ»¿é¡ï¼Œä½†åŸæ°‘ç”Ÿæ¯”è¼ƒç‰¹æ®Šï¼Œå¾ˆå¤šç§‘ç³»æ˜¯<strong>ä¸æ»¿é¡</strong>ï¼ˆé€™ä¸ä»£è¡¨ç§‘ç³»ä¸å¥½ï¼‰ï¼Œå› æ­¤æ¯”è¼ƒå®¹æ˜“æœ‰ç¬¬äºŒéšæ®µé¢è©¦æ©Ÿæœƒã€‚æˆ‘å€‘å¯åˆ©ç”¨æ­¤ç‰¹æ€§å°‹æ‰¾æ©Ÿæœƒã€‚
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ç­–ç•¥ 1 -->
                            <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                                <h4 class="font-bold text-gray-800 text-lg mb-2 border-b pb-2">ç­–ç•¥ 1ï¼šåœ‹ç«‹å­¸æ ¡ï¼Œå†·é–€ç§‘ç³»</h4>
                                <p class="mb-3 text-gray-600">ç›®æ¨™ï¼šæ‰¾åˆ°è¿‘ 3 å¹´å…§ï¼Œåœ‹ç«‹å¤§å­¸ä¸­ï¼ŒåŸä½æ°‘æ¯”è¼ƒå°‘å ±åçš„ç§‘ç³»ã€‚</p>
                                <div class="bg-gray-50 p-3 rounded-lg space-y-2 text-sm font-mono">
                                    <div class="flex items-center"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs mr-2">æ¢ä»¶1</span> å­¸æ ¡ <span class="text-pink-500 font-bold mx-1">åŒ…å«</span> "åœ‹ç«‹"</div>
                                    <div class="flex items-center"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs mr-2">æ¢ä»¶2</span> 114é è¨ˆé€šéä¸€éšäººæ•¸ <span class="text-blue-500 font-bold mx-1">&gt;</span> 114é€šéä¸€éšå¤–åŠ </div>
                                    <div class="flex items-center"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs mr-2">æ¢ä»¶3</span> 113é è¨ˆé€šéä¸€éšäººæ•¸ <span class="text-blue-500 font-bold mx-1">&gt;</span> 113é€šéä¸€éšå¤–åŠ </div>
                                    <div class="flex items-center"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs mr-2">æ¢ä»¶4</span> 112é è¨ˆé€šéä¸€éšäººæ•¸ <span class="text-blue-500 font-bold mx-1">&gt;</span> 112é€šéä¸€éšå¤–åŠ </div>
                                </div>
                                <p class="mt-2 text-xs text-gray-500">* è‹¥æ¢ä»¶å¤ªåš´æ ¼ï¼Œå¯åˆªé™¤æ¢ä»¶4 (çœ‹è¿‘2å¹´å³å¯)ã€‚</p>
                            </div>

                            <!-- ç­–ç•¥ 2 -->
                            <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                                <h4 class="font-bold text-gray-800 text-lg mb-2 border-b pb-2">ç­–ç•¥ 2ï¼šç‰¹å®šç§‘ç³»ï¼Œå†·é–€å­¸æ ¡</h4>
                                <p class="mb-3 text-gray-600">ç›®æ¨™ï¼šæ‰¾åˆ°ç‰¹å®šç§‘ç³»(å¦‚ç¤¾å·¥)ï¼Œè¿‘ 3 å¹´å…§æ¯”è¼ƒå°‘äººå ±åçš„å­¸æ ¡ã€‚</p>
                                <div class="bg-gray-50 p-3 rounded-lg space-y-2 text-sm font-mono">
                                    <div class="flex items-center"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs mr-2">æ¢ä»¶1</span> æ ¡ç³»åç¨± <span class="text-pink-500 font-bold mx-1">åŒ…å«</span> "ç¤¾æœƒå·¥ä½œ"</div>
                                    <div class="flex items-center"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs mr-2">æ¢ä»¶2</span> 114é è¨ˆ... <span class="text-blue-500 font-bold mx-1">&gt;</span> 114é€šéä¸€éšå¤–åŠ </div>
                                    <div class="flex items-center"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs mr-2">æ¢ä»¶3</span> 113é è¨ˆ... <span class="text-blue-500 font-bold mx-1">&gt;</span> 113é€šéä¸€éšå¤–åŠ </div>
                                </div>
                                <p class="mt-2 text-xs text-gray-500">* å¯è‡ªè¡Œå°‡ã€Œç¤¾æœƒå·¥ä½œã€æ›¿æ›ç‚ºå…¶ä»–æ„Ÿèˆˆè¶£çš„é—œéµå­—ã€‚</p>
                            </div>
                        </div>

                    </div>
                </details>
            </section>

            <!-- ç¯©é¸å™¨å€åŸŸ (æ”¹ç‚ºæ¼¸å±¤å¡ç‰‡) -->
            <section id="filter-controls" class="mb-6 hidden bg-gradient-to-br from-blue-50 to-green-50 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ” ç¯©é¸è³‡æ–™</h2>
                
                <!-- æç¤ºå€å¡Š -->
                <div class="mb-4 p-3 bg-blue-100 border border-blue-200 text-blue-800 rounded-lg text-sm" role="alert">
                    <strong class="font-semibold">ğŸ’¡ ç¯©é¸é‚è¼¯ï¼š</strong>
                    ç³»çµ±æœƒ<strong>ç”±ä¸Šåˆ°ä¸‹</strong>ä¾åºåŸ·è¡Œç¯©é¸æ¢ä»¶ã€‚ä¾‹å¦‚ï¼šå¸Œæœ›é‚è¼¯ç‚º "æ¢ä»¶1 AND (æ¢ä»¶2 OR æ¢ä»¶3)"ï¼Œè«‹å°‡æ¢ä»¶1ç§»åˆ°æœ€å¾Œè¨­å®šã€‚
                </div>

                <!-- å‹•æ…‹æ¢ä»¶çµ„å®¹å™¨ -->
                <div id="filter-groups-container" class="space-y-4">
                    <!-- æ¢ä»¶çµ„å°‡ç”± JS å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
                
                <!-- ä¸»è¦æ“ä½œæŒ‰éˆ• -->
                <div class="flex flex-wrap gap-4 mt-6">
                    <button id="add-filter-btn" class="btn-add rounded-xl py-2 px-4 font-medium flex items-center">
                        <span class="text-lg mr-2">âœ¨</span>
                        ï¼‹ æ–°å¢æ¢ä»¶
                    </button>
                    <button id="clear-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-xl transition duration-300">
                        æ¸…é™¤å…¨éƒ¨
                    </button>
                    <button id="filter-button" class="btn-upload rounded-xl py-2 px-6 font-bold ml-auto">
                        å¥—ç”¨ç¯©é¸
                    </button>
                </div>
            </section>

            <!-- é¡¯ç¤ºè®€å–åˆ°çš„è³‡æ–™ -->
            <section class="mt-6">
                <!-- æ¨™é¡Œ å’Œ åŒ¯å‡ºæŒ‰éˆ• -->
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-800">ğŸ“Š ç¯©é¸çµæœ:</h2>
                    <button id="export-button" class="hidden btn-add rounded-xl py-2 px-4 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="align-middle">åŒ¯å‡º (XLSX)</span>
                    </button>
                </div>

                <!-- æ¢ä»¶æ¨™ç±¤ (Chips) å®¹å™¨ -->
                <div id="filter-chips-container" class="flex flex-wrap gap-2 mb-4">
                    <!-- ç¯©é¸æ¢ä»¶æ¨™ç±¤å°‡ç”± JS å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>

                <!-- çµæœè¡¨æ ¼ -->
                <div id="results-output" class="w-full h-96 bg-white text-gray-800 text-sm p-4 rounded-md overflow-auto border border-gray-200 shadow-inner">
                    è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥...
                </div>
            </section>

            <!-- è¨è«–å€å€å¡Š -->
            <section id="forum-section" class="mt-8 pt-8 border-t border-gray-200 hidden">
                <!-- æ¨™é¡Œ å’Œ ç™¼å¸–æŒ‰éˆ• -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">ğŸ’¬ è¨è«–å€</h2>
                    <div class="flex gap-4">
                        <button id="show-new-post-form-btn" class="btn-add rounded-xl py-2 px-4 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -ml-1 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            ç™¼è¡¨æ–°å¸–
                        </button>
                    </div>
                </div>
                
                <!-- è¨è«–å€ç¯©é¸å™¨ -->
                <div id="forum-filter-controls" class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- é—œéµå­— -->
                        <div>
                            <label for="forum-search-keyword" class="block text-sm font-medium text-gray-700 mb-1">é—œéµå­—</label>
                            <input type="text" id="forum-search-keyword" class="w-full p-2 form-input-style" placeholder="æ¨™é¡Œã€å…§å®¹ã€æ ¡ç³»...">
                        </div>
                        <!-- åˆ†é¡ -->
                        <div>
                            <label for="forum-search-category" class="block text-sm font-medium text-gray-700 mb-1">ä¸»é¡Œåˆ†é¡</label>
                            <select id="forum-search-category" class="w-full p-2 form-input-style">
                                <option value="">å…¨éƒ¨åˆ†é¡</option>
                                <option value="æ ¡ç³»è³‡è¨Šè©¢å•">æ ¡ç³»è³‡è¨Šè©¢å•</option>
                                <option value="å¿—é¡˜å¡«å¯«ç­–ç•¥">å¿—é¡˜å¡«å¯«ç­–ç•¥</option>
                                <option value="ç¶“é©—åˆ†äº«">ç¶“é©—åˆ†äº«</option>
                                <option value="å…¶ä»–å•é¡Œ">å…¶ä»–å•é¡Œ</option>
                            </select>
                        </div>
                        <!-- ç‹€æ…‹ -->
                        <div>
                            <label for="forum-search-status" class="block text-sm font-medium text-gray-700 mb-1">äº’å‹•ç‹€æ…‹</label>
                            <select id="forum-search-status" class="w-full p-2 form-input-style">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="unreplied">æœªå›è¦†</option>
                                <option value="replied">å·²å›è¦†</option>
                            </select>
                        </div>
                    </div>
                    <!-- é—œè¯æ ¡ç³»ç¯©é¸ -->
                    <div class="mt-4">
                        <label for="forum-search-linked-dept" class="block text-sm font-medium text-gray-700 mb-1">é—œè¯æ ¡ç³»</label>
                        <select id="forum-search-linked-dept" class="w-full p-2 form-input-style">
                            <option value="">å…¨éƒ¨æ ¡ç³»</option>
                            <!-- ç”± JS è¼‰å…¥ -->
                        </select>
                    </div>
                </div>

                <!-- å¸–å­åˆ—è¡¨ -->
                <div id="post-list-container" class="space-y-4">
                    <p class="text-gray-500">æ­£åœ¨è¼‰å…¥å¸–å­...</p>
                    <!-- å¸–å­åˆ—è¡¨å°‡ç”± JS å‹•æ…‹æ’å…¥ -->
                </div>
            </section>
            
            <!-- ç•™è¨€æ¿é—œé–‰æ™‚çš„æç¤º (éç®¡ç†å“¡) -->
            <section id="forum-disabled-msg" class="mt-8 pt-8 border-t border-gray-200 hidden text-center">
                <h2 class="text-2xl font-semibold text-gray-400 mb-2">ğŸ’¬ è¨è«–å€</h2>
                <p class="text-gray-500 bg-gray-100 py-6 rounded-xl">è¨è«–å€ç›®å‰é—œé–‰ä¸­ã€‚</p>
            </section>

        </main>
        
        <!-- æ–°å¢å¸–å­è¡¨å–®è¦–åœ– (é è¨­éš±è—) -->
        <div id="new-post-form-view" class="hidden">
            <button id="back-to-main-btn-1" class="mb-4 text-blue-600 hover:underline font-medium">&larr; è¿”å›åˆ—è¡¨</button>
            <main class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">ç™¼è¡¨æ–°å¸–å­</h2>
                <form id="new-post-form">
                    <!-- ä¸»é¡Œåˆ†é¡ -->
                    <div class="mb-4">
                        <label for="post-category" class="block text-sm font-medium text-gray-700 mb-1">ä¸»é¡Œåˆ†é¡</label>
                        <select id="post-category" required class="w-full p-3 form-input-style">
                            <option value="">-- è«‹é¸æ“‡åˆ†é¡ --</option>
                            <option value="æ ¡ç³»è³‡è¨Šè©¢å•">æ ¡ç³»è³‡è¨Šè©¢å•</option>
                            <option value="å¿—é¡˜å¡«å¯«ç­–ç•¥">å¿—é¡˜å¡«å¯«ç­–ç•¥</option>
                            <option value="ç¶“é©—åˆ†äº«">ç¶“é©—åˆ†äº«</option>
                            <option value="å…¶ä»–å•é¡Œ">å…¶ä»–å•é¡Œ</option>
                        </select>
                    </div>
                    
                    <!-- é—œè¯æ ¡ç³» (å–®ä¸€ä¸‹æ‹‰é¸å–®) -->
                    <div class="mb-4">
                        <label for="post-link-dept" class="block text-sm font-medium text-gray-700 mb-1">é—œè¯æ ¡ç³» (é¸å¡«)</label>
                        <select id="post-link-dept" class="w-full p-3 form-input-style">
                            <option value="">-- ç„¡é ˆé—œè¯ --</option>
                            <!-- ç”± JS è¼‰å…¥ -->
                        </select>
                    </div>

                    <!-- é—œè¯è³‡æ–™é è¦½ -->
                    <div id="post-link-preview" class="hidden bg-blue-50 border border-blue-200 p-3 rounded-lg text-sm text-blue-800 mb-4">
                        <!-- é—œè¯è³‡æ–™å°‡é¡¯ç¤ºæ–¼æ­¤ -->
                    </div>

                    <!-- æ¨™é¡Œ -->
                    <div class="mb-4">
                        <label for="post-title" class="block text-sm font-medium text-gray-700 mb-1">æ¨™é¡Œ</label>
                        <input type="text" id="post-title" required class="w-full p-3 form-input-style" placeholder="è«‹è¼¸å…¥å•é¡Œæˆ–ä¸»é¡Œæ¨™é¡Œ...">
                    </div>
                    <!-- å…§å®¹ -->
                    <div class="mb-6">
                        <label for="post-content" class="block text-sm font-medium text-gray-700 mb-1">å…§å®¹</label>
                        <textarea id="post-content" rows="10" required class="w-full p-3 form-input-style" placeholder="è«‹è©³ç´°æè¿°æ‚¨çš„å•é¡Œ..."></textarea>
                    </div>

                    <div class="flex justify-end gap-4">
                        <button type="button" id="cancel-post-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-xl transition duration-300">å–æ¶ˆ</button>
                        <button type="submit" id="submit-post-btn" class="btn-upload rounded-xl py-2 px-6">
                            <span id="submit-post-spinner" class="hidden">...</span>
                            <span>ç™¼ä½ˆ</span>
                        </button>
                    </div>
                </form>
            </main>
        </div>
        
        <!-- å¸–å­è©³æƒ…è¦–åœ– (é è¨­éš±è—) -->
        <div id="forum-detail-view" class="hidden">
            <button id="back-to-main-btn-2" class="mb-4 text-blue-600 hover:underline font-medium">&larr; è¿”å›åˆ—è¡¨</button>
            <main class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                <!-- å¸–å­å…§å®¹å°‡ç”± JS è¼‰å…¥ -->
                <div id="post-detail-content" class="mb-8 pb-8 border-b border-gray-200">
                    <p class="text-gray-500">æ­£åœ¨è¼‰å…¥å¸–å­å…§å®¹...</p>
                </div>

                <!-- å›è¦†åˆ—è¡¨ -->
                <h3 class="text-xl font-semibold text-gray-800 mb-4">æ‰€æœ‰å›è¦†</h3>
                <div id="replies-list-container" class="space-y-5 mb-8">
                    <p class="text-gray-500">æ­£åœ¨è¼‰å…¥å›è¦†...</p>
                </div>

                <!-- å›è¦†è¡¨å–® -->
                <form id="new-reply-form" class="mt-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">ç™¼è¡¨æ‚¨çš„å›è¦†</h3>
                    <textarea id="reply-content" rows="4" required class="w-full p-3 form-input-style mb-3" placeholder="è«‹è¼¸å…¥æ‚¨çš„å›è¦†..."></textarea>
                    <div class="flex justify-end">
                        <button type="submit" id="submit-reply-btn" class="btn-add rounded-xl py-2 px-4">
                            <span id="submit-reply-spinner" class="hidden">...</span>
                            <span>é€å‡ºå›è¦†</span>
                        </button>
                    </div>
                </form>
            </main>
        </div>

    </div>

    <script type="module">
        // è¼‰å…¥ v9 æ¨¡çµ„åŒ–å‡½å¼ (åŒ…å« Google Auth å’Œ è¨è«–å€åŠŸèƒ½)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            setLogLevel,
            collection,    
            addDoc,        
            serverTimestamp, 
            query,         
            orderBy,       
            getDoc,        
            deleteDoc,     
            updateDoc,     
            increment,     
            where,         
            Timestamp      
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        
        // Debounce å‡½å¼
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // å°‡æ‰€æœ‰ç¨‹å¼ç¢¼æ”¾å…¥ DOMContentLoaded äº‹ä»¶ä¸­
        document.addEventListener('DOMContentLoaded', () => {

            // ç™»å…¥ç›¸é—œ DOM å…ƒç´ 
            const loginContainerEl = document.getElementById('login-container');
            const appContainerEl = document.getElementById('app-container');
            const googleLoginBtn = document.getElementById('google-login-btn'); 
            const loginErrorEl = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');
            const uploadSectionEl = document.getElementById('upload-section');
            const userDisplayEl = document.getElementById('user-display'); 

            // è¦–åœ–åˆ‡æ› DOM å…ƒç´ 
            const mainAppViewEl = document.getElementById('main-app-view');
            const newPostFormViewEl = document.getElementById('new-post-form-view');
            const forumDetailViewEl = document.getElementById('forum-detail-view');

            // (æ—¢æœ‰) DOM å…ƒç´ 
            const fileInputEl = document.getElementById('file-input');
            const fileNameEl = document.getElementById('file-name');
            const resultsOutputEl = document.getElementById('results-output');
            const filterControlsEl = document.getElementById('filter-controls');
            const filterButtonEl = document.getElementById('filter-button');
            const exportButtonEl = document.getElementById('export-button');
            const filterGroupsContainerEl = document.getElementById('filter-groups-container');
            const addFilterBtnEl = document.getElementById('add-filter-btn');
            const clearFiltersBtnEl = document.getElementById('clear-filters-btn');
            const filterChipsContainerEl = document.getElementById('filter-chips-container');
            
            // è¨è«–å€ DOM å…ƒç´ 
            const forumSectionEl = document.getElementById('forum-section');
            const forumDisabledMsgEl = document.getElementById('forum-disabled-msg');
            const showNewPostFormBtn = document.getElementById('show-new-post-form-btn');
            const postListContainerEl = document.getElementById('post-list-container');
            // ç™¼å¸–è¡¨å–®
            const newPostFormEl = document.getElementById('new-post-form');
            const postCategoryEl = document.getElementById('post-category'); 
            const postLinkDeptEl = document.getElementById('post-link-dept'); 
            const postLinkPreviewEl = document.getElementById('post-link-preview'); 
            const postTitleEl = document.getElementById('post-title');
            const postContentEl = document.getElementById('post-content');
            const cancelPostBtn = document.getElementById('cancel-post-btn');
            const submitPostBtn = document.getElementById('submit-post-btn');
            // è©³æƒ…é 
            const postDetailContentEl = document.getElementById('post-detail-content');
            const repliesListContainerEl = document.getElementById('replies-list-container');
            const newReplyFormEl = document.getElementById('new-reply-form');
            const replyContentEl = document.getElementById('reply-content');
            const submitReplyBtn = document.getElementById('submit-reply-btn');
            // è¿”å›æŒ‰éˆ•
            const backToMainBtn1 = document.getElementById('back-to-main-btn-1');
            const backToMainBtn2 = document.getElementById('back-to-main-btn-2');
            
            // è¨è«–å€ç¯©é¸å™¨ DOM
            const forumFilterControlsEl = document.getElementById('forum-filter-controls');
            const forumSearchKeywordEl = document.getElementById('forum-search-keyword');
            const forumSearchCategoryEl = document.getElementById('forum-search-category');
            const forumSearchStatusEl = document.getElementById('forum-search-status');
            const forumSearchLinkedDeptEl = document.getElementById('forum-search-linked-dept');
            const forumFilterInputs = [forumSearchKeywordEl, forumSearchCategoryEl, forumSearchStatusEl, forumSearchLinkedDeptEl];

            // ç®¡ç†å“¡é–‹é—œ
            const forumToggle = document.getElementById('forum-toggle');
            const forumStatusText = document.getElementById('forum-status-text');


            // å…¨åŸŸè®Šæ•¸å„²å­˜è³‡æ–™
            let allHeaders = [];
            let allDataRows = [];
            let availableColumns = []; // å„²å­˜ { name, index }
            let currentExportData = null;
            let activeFilters = []; // å„²å­˜ç•¶å‰å¥—ç”¨çš„ç¯©é¸æ¢ä»¶
            
            // æ ¡ç³»è³‡æ–™å¿«å–
            let schoolDataCache = {
                schoolColIdx: -1,
                deptColIdx: -1,
                col112Idx: -1,
                col113Idx: -1,
                linkedDeptList: [] // å„²å­˜ { text: "å­¸æ ¡ - ç§‘ç³»", school: "...", dept: "..." }
            };


            // Firebase å…¨åŸŸè®Šæ•¸
            let app, db, auth;
            let userId = null;
            let schoolDataDocRef = null; 
            let systemSettingsRef = null; // ç³»çµ±è¨­å®š
            let unsubscribeData = null; 
            let unsubscribeSettings = null; // ç³»çµ±è¨­å®šç›£è½
            
            // è¨è«–å€ Firebase è®Šæ•¸
            let forumPostsRef = null;
            let unsubscribeForumPosts = null; 
            let unsubscribeReplies = null;
            let currentPostId = null; // è¿½è¹¤ç•¶å‰æŸ¥çœ‹çš„å¸–å­ ID
            let currentUserEmail = null;
            let currentUserDisplayName = null;
            
            // è¨è«–å€å®¢æˆ¶ç«¯è³‡æ–™å¿«å–
            let postsCache = [];
            let forumFilters = {}; 

            // ç³»çµ±è¨­å®š
            let isForumEnabled = false; // é è¨­é—œé–‰

            // Firebase è¨­å®š
            const firebaseConfig = {
                apiKey: "AIzaSyDw1JOQi3lgGk-9fQbs2MbW-wJd008kqKM",
                authDomain: "screening-strategy.firebaseapp.com",
                projectId: "screening-strategy",
                storageBucket: "screening-strategy.firebasestorage.app",
                messagingSenderId: "675450449375",
                appId: "1:675450449375:web:521bdb4854092f1c05e86a",
                measurementId: "G-GMLSW66F6F"
            };

            // ç™»å…¥ç‹€æ…‹
            let currentUserRole = null;
            
            // è¦–åœ–ç®¡ç†å™¨
            function showView(viewId, context = null) {
                // éš±è—æ‰€æœ‰è¦–åœ–
                mainAppViewEl.classList.add('hidden');
                newPostFormViewEl.classList.add('hidden');
                forumDetailViewEl.classList.add('hidden');

                // åœæ­¢ç›£è½å›è¦† (å¦‚æœæ­£åœ¨ç›£è½)
                if (unsubscribeReplies) {
                    unsubscribeReplies();
                    unsubscribeReplies = null;
                }
                currentPostId = null;

                switch (viewId) {
                    case 'new-post':
                        newPostFormEl.reset(); // æ¸…ç©ºè¡¨å–®
                        postLinkPreviewEl.classList.add('hidden'); 
                        newPostFormViewEl.classList.remove('hidden');
                        break;
                    case 'detail':
                        forumDetailViewEl.classList.remove('hidden');
                        currentPostId = context; // å„²å­˜ç•¶å‰å¸–å­ ID
                        loadPostDetail(currentPostId); // è¼‰å…¥å¸–å­å…§å®¹
                        break;
                    case 'main':
                    default:
                        mainAppViewEl.classList.remove('hidden');
                        break;
                }
                window.scrollTo(0, 0); // åˆ‡æ›è¦–åœ–æ™‚æ»¾å‹•åˆ°é ‚éƒ¨
            }

            /**
             * ç™»å…¥å‡½å¼ (åƒ…è™•ç† UI åˆ‡æ›)
             * @param {string} role 'admin' æˆ– 'user'
             */
            function handleLogin(role, userEmail) {
                currentUserRole = role;

                // åˆ‡æ› UI
                loginContainerEl.classList.add('hidden');
                appContainerEl.classList.remove('hidden');
                loginErrorEl.textContent = '';
                
                if (role === 'admin') {
                    uploadSectionEl.classList.remove('hidden');
                    resultsOutputEl.innerHTML = 'è«‹ä¸Šå‚³æª”æ¡ˆæˆ–ç­‰å¾…è³‡æ–™åº«è¼‰å…¥...';
                    userDisplayEl.textContent = `ç®¡ç†è€… (${userEmail}) å·²ç™»å…¥`;
                    // ç®¡ç†è€…æ°¸é å¯ä»¥çœ‹è¦‹é–‹é—œ
                    forumToggle.disabled = false;
                } else { // 'user'
                    uploadSectionEl.classList.add('hidden');
                    resultsOutputEl.innerHTML = 'æ­£åœ¨å¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™...';
                    userDisplayEl.textContent = `ä½¿ç”¨è€… (${userEmail}) å·²ç™»å…¥`;
                }
                
                // æ›´æ–°ç•™è¨€æ¿å¯è¦‹æ€§
                updateForumVisibility();
            }

            /**
             * ç™»å‡ºå‡½å¼ (åƒ…è™•ç† UI é‡è¨­)
             */
            function handleLogout() {
                currentUserRole = null;
                currentUserEmail = null;
                currentUserDisplayName = null;

                // åœæ­¢ç›£è½
                if (unsubscribeData) { unsubscribeData(); unsubscribeData = null; }
                if (unsubscribeSettings) { unsubscribeSettings(); unsubscribeSettings = null; }
                if (unsubscribeForumPosts) { unsubscribeForumPosts(); unsubscribeForumPosts = null; }
                if (unsubscribeReplies) { unsubscribeReplies(); unsubscribeReplies = null; }

                // åˆ‡æ›å›ä¸»è¦–åœ–
                showView('main');

                // åˆ‡æ› UI
                loginContainerEl.classList.remove('hidden');
                appContainerEl.classList.add('hidden');
                userDisplayEl.textContent = ''; 

                // é‡è¨­æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
                fileInputEl.value = ''; // æ¸…é™¤æª”æ¡ˆè¼¸å…¥
                fileNameEl.textContent = 'æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ';
                resultsOutputEl.innerHTML = 'è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥...'; 
                exportButtonEl.classList.add('hidden');
                currentExportData = null;
                filterControlsEl.classList.add('hidden');
                
                // æ¸…ç©ºè¨è«–å€
                postListContainerEl.innerHTML = '';
                postDetailContentEl.innerHTML = '';
                repliesListContainerEl.innerHTML = '';
                postsCache = []; 
                
                allHeaders = [];
                allDataRows = [];
                availableColumns = [];
                clearAllFilters(false); // æ¸…é™¤ç¯©é¸å™¨ä½†ä¸é¡¯ç¤ºé è¦½
            }

            /**
             * Google ç™»å…¥å‡½å¼ (åŠ å…¥ç™»å…¥æ™‚é©—è­‰)
             */
            async function signInWithGoogle() {
                if (!auth) {
                    console.error("Auth å°šæœªåˆå§‹åŒ–ã€‚");
                    loginErrorEl.textContent = 'å…ƒä»¶å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™...';
                    return;
                }

                const provider = new GoogleAuthProvider();
                
                // é™åˆ¶ç™»å…¥ç¶²åŸŸ
                provider.setCustomParameters({
                    'hd': 'ppsh.ptc.edu.tw'
                });

                try {
                    loginErrorEl.textContent = 'æ­£åœ¨é–‹å•Ÿ Google ç™»å…¥è¦–çª—...';
                    const result = await signInWithPopup(auth, provider);
                    
                    // ç™»å…¥å¾Œç«‹åˆ»æª¢æŸ¥
                    const user = result.user;
                    const userEmail = user.email || '';
                    
                    if (userEmail === 'fuwen@ppsh.ptc.edu.tw' || userEmail.endsWith('@ppsh.ptc.edu.tw')) {
                        // ç¶²åŸŸæ­£ç¢ºï¼ŒonAuthStateChanged æœƒæ¥æ‰‹è™•ç†
                        loginErrorEl.textContent = '';
                    } else {
                        // ç¶²åŸŸä¸ç¬¦ï¼Œç«‹åˆ»ç™»å‡ºä¸¦é¡¯ç¤ºéŒ¯èª¤
                        loginErrorEl.textContent = 'éŒ¯èª¤ï¼šåƒ…å…è¨± @ppsh.ptc.edu.tw ç¶²åŸŸç™»å…¥ã€‚';
                        await signOut(auth);
                    }

                } catch (error) {
                    console.error("Google ç™»å…¥å¤±æ•—:", error);
                    
                    if (error.code === 'auth/unauthorized-domain') {
                        const currentDomain = window.location.hostname;
                        loginErrorEl.textContent = `éŒ¯èª¤ï¼šç¶²åŸŸ ${currentDomain} æœªè¢«æˆæ¬Šã€‚`;
                        alert(`ç™»å…¥å¤±æ•—ï¼šæ­¤æ‡‰ç”¨ç¨‹å¼çš„ç¶²åŸŸ (${currentDomain}) æœªè¢«åŠ å…¥åˆ° Firebase å°ˆæ¡ˆçš„ã€Œæˆæ¬Šç¶²åŸŸã€æ¸…å–®ä¸­ã€‚è«‹è¯ç¹«ç®¡ç†è€…è™•ç†ã€‚`);
                    }
                    else if (error.code === 'auth/popup-closed-by-user') {
                        loginErrorEl.textContent = 'ç™»å…¥è¦–çª—å·²é—œé–‰ã€‚';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        // å¿½ç•¥
                    } else if (error.code === 'auth/operation-not-allowed') {
                         loginErrorEl.textContent = 'éŒ¯èª¤ï¼šå°šæœªåœ¨ Firebase å°ˆæ¡ˆä¸­å•Ÿç”¨ Google ç™»å…¥ã€‚';
                    }
                    else {
                        loginErrorEl.textContent = `ç™»å…¥å¤±æ•—ï¼š${error.message}`;
                    }
                }
            }
            
            /**
             * åˆå§‹åŒ– Firebase æ‡‰ç”¨å’Œèªè­‰
             */
            async function initializeAppAndAuth() {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // ç°¡åŒ–è·¯å¾‘
                    schoolDataDocRef = doc(db, 'public_data', 'school_data');
                    systemSettingsRef = doc(db, 'public_data', 'system_settings');
                    forumPostsRef = collection(db, 'forum_posts');

                    // æ ¸å¿ƒèªè­‰é‚è¼¯
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // ä½¿ç”¨è€…å·²ç™»å…¥
                            userId = user.uid;
                            const userEmail = user.email || '';
                            
                            // å„²å­˜ä½¿ç”¨è€…è³‡è¨Š
                            currentUserEmail = userEmail;
                            currentUserDisplayName = user.displayName || userEmail.split('@')[0];
                            
                            // é–‹å§‹ç›£è½ç³»çµ±è¨­å®š
                            listenForSystemSettings();

                            if (userEmail === 'fuwen@ppsh.ptc.edu.tw') {
                                // ç®¡ç†è€…
                                console.log("ç®¡ç†è€…ç™»å…¥:", userId, userEmail);
                                handleLogin('admin', userEmail);
                                listenForSchoolData(); // ç™»å…¥æˆåŠŸå¾Œé–‹å§‹ç›£è½
                                listenForForumPosts(); // ç›£è½è¨è«–å€
                            } 
                            else if (userEmail.endsWith('@ppsh.ptc.edu.tw')) {
                                // ä¸€èˆ¬ä½¿ç”¨è€…
                                console.log("ä¸€èˆ¬ä½¿ç”¨è€…ç™»å…¥:", userId, userEmail);
                                handleLogin('user', userEmail);
                                listenForSchoolData(); // ç™»å…¥æˆåŠŸå¾Œé–‹å§‹ç›£è½
                                listenForForumPosts(); // ç›£è½è¨è«–å€
                            } 
                            else {
                                // ç¶²åŸŸä¸ç¬¦
                                console.warn("ç¶²åŸŸä¸ç¬¦ï¼Œå¼·åˆ¶ç™»å‡º:", userEmail);
                                loginErrorEl.textContent = 'éŒ¯èª¤ï¼šåƒ…å…è¨± @ppsh.ptc.edu.tw ç¶²åŸŸç™»å…¥ã€‚';
                                signOut(auth); // å¼·åˆ¶ç™»å‡º
                            }
                            
                        } else {
                            // ä½¿ç”¨è€…å·²ç™»å‡º
                            userId = null;
                            console.log("ä½¿ç”¨è€…å·²ç™»å‡º");
                            handleLogout(); // å‘¼å«ç™»å‡º UI
                        }
                    });

                } catch (e) {
                    console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                    if (resultsOutputEl) {
                        resultsOutputEl.innerHTML = `Firebase åˆå§‹åŒ–å¤±æ•—: ${e.message}ã€‚è«‹åˆ·æ–°é é¢ã€‚`;
                    }
                }
            }

            /**
             * ç›£è½ç³»çµ±è¨­å®š (ç•™è¨€æ¿é–‹é—œ)
             */
            function listenForSystemSettings() {
                if (unsubscribeSettings) unsubscribeSettings();

                unsubscribeSettings = onSnapshot(systemSettingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        isForumEnabled = data.forumEnabled === true; // é è¨­ç‚º false
                    } else {
                        isForumEnabled = false; // è‹¥æª”æ¡ˆä¸å­˜åœ¨ï¼Œé è¨­é—œé–‰
                    }
                    
                    // æ›´æ–° UI
                    updateForumUIState();
                }, (error) => {
                    console.error("ç›£è½ç³»çµ±è¨­å®šå¤±æ•—:", error);
                });
            }

            /**
             * æ›´æ–°ç•™è¨€æ¿ UI ç‹€æ…‹ (é–‹é—œé¡¯ç¤º & ç•™è¨€æ¿å¯è¦‹æ€§)
             */
            function updateForumUIState() {
                // æ›´æ–°é–‹é—œç‹€æ…‹
                forumToggle.checked = isForumEnabled;
                if (isForumEnabled) {
                    forumStatusText.textContent = "å·²é–‹å•Ÿ";
                    forumStatusText.classList.remove('text-gray-500');
                    forumStatusText.classList.add('text-green-500');
                } else {
                    forumStatusText.textContent = "å·²é—œé–‰";
                    forumStatusText.classList.remove('text-green-500');
                    forumStatusText.classList.add('text-gray-500');
                }

                updateForumVisibility();
            }

            /**
             * æ§åˆ¶ç•™è¨€æ¿å€å¡Šçš„å¯è¦‹æ€§
             */
            function updateForumVisibility() {
                if (!currentUserRole) return; // å°šæœªç™»å…¥

                if (currentUserRole === 'admin') {
                    // ç®¡ç†è€…ï¼šæ°¸é å¯è¦‹
                    forumSectionEl.classList.remove('hidden');
                    forumDisabledMsgEl.classList.add('hidden');
                } else {
                    // ä¸€èˆ¬ä½¿ç”¨è€…ï¼šä¾æ“šè¨­å®š
                    if (isForumEnabled) {
                        forumSectionEl.classList.remove('hidden');
                        forumDisabledMsgEl.classList.add('hidden');
                    } else {
                        forumSectionEl.classList.add('hidden');
                        forumDisabledMsgEl.classList.remove('hidden');
                    }
                }
            }

            /**
             * åˆ‡æ›ç•™è¨€æ¿ç‹€æ…‹ (å¯«å…¥è³‡æ–™åº«)
             */
            async function toggleForumStatus() {
                if (currentUserRole !== 'admin') return;

                const newState = forumToggle.checked;
                // UI æœƒç”± onSnapshot æ›´æ–°ï¼Œé€™è£¡å…ˆä¸åš UI è®Šå‹•ï¼Œé˜²æ­¢ä¸åŒæ­¥
                
                try {
                    await setDoc(systemSettingsRef, {
                        forumEnabled: newState
                    }, { merge: true });
                    console.log("ç•™è¨€æ¿ç‹€æ…‹å·²æ›´æ–°ç‚º:", newState);
                } catch (e) {
                    console.error("æ›´æ–°ç•™è¨€æ¿ç‹€æ…‹å¤±æ•—:", e);
                    alert("æ›´æ–°å¤±æ•—ï¼š" + e.message);
                    // å¤±æ•—æ™‚å›å¾©é–‹é—œç‹€æ…‹
                    forumToggle.checked = !newState;
                }
            }
            
            /**
             * ç›£è½å…¬ç”¨è³‡æ–™åº«ä¸­çš„è³‡æ–™
             */
            function listenForSchoolData() {
                if (!schoolDataDocRef) {
                    console.error("Database reference is not set.");
                    return;
                }

                // é˜²æ­¢é‡è¤‡ç›£è½
                if (unsubscribeData) {
                    unsubscribeData();
                }

                resultsOutputEl.textContent = 'æ­£åœ¨å¾è³‡æ–™åº«åŒæ­¥è³‡æ–™...';

                unsubscribeData = onSnapshot(schoolDataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        // è³‡æ–™å­˜åœ¨
                        const data = docSnap.data();
                        try {
                            allHeaders = data.headers || [];
                            allDataRows = JSON.parse(data.rows_json || '[]'); 
                            
                            populateAvailableColumns();
                            processSchoolDataCache();
                            populateLinkedSchoolDropdowns();
                            filterControlsEl.classList.remove('hidden');
                            clearAllFilters(true); // é¡¯ç¤ºé è¦½
                            
                            fileNameEl.textContent = `å·²å¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™ (æœ€å¾Œæ›´æ–°æ–¼: ${new Date().toLocaleTimeString()})`;
                            console.log("è³‡æ–™åº«è³‡æ–™å·²è¼‰å…¥");

                        } catch (e) {
                            console.error("è§£æè³‡æ–™åº«è³‡æ–™å¤±æ•—:", e);
                            resultsOutputEl.textContent = `è§£æè³‡æ–™åº«è³‡æ–™å¤±æ•—: ${e.message}`;
                        }

                    } else {
                        // è³‡æ–™ä¸å­˜åœ¨
                        console.log("è³‡æ–™åº«ä¸­å°šç„¡è³‡æ–™");
                        allHeaders = [];
                        allDataRows = [];
                        schoolDataCache = { linkedDeptList: [] };
                        populateLinkedSchoolDropdowns();
                        filterControlsEl.classList.add('hidden');

                        if (currentUserRole === 'admin') {
                            fileNameEl.textContent = 'è³‡æ–™åº«ç‚ºç©ºï¼Œè«‹ä¸Šå‚³æª”æ¡ˆã€‚';
                            resultsOutputEl.innerHTML = 'è³‡æ–™åº«ç‚ºç©ºã€‚è«‹ä¸Šå‚³æª”æ¡ˆä»¥å»ºç«‹è³‡æ–™ã€‚';
                        } else {
                            fileNameEl.textContent = 'å°šç„¡è³‡æ–™';
                            resultsOutputEl.innerHTML = 'ç›®å‰è³‡æ–™åº«ä¸­æ²’æœ‰è³‡æ–™ã€‚è«‹ç­‰å¾…ç®¡ç†è€…ä¸Šå‚³ã€‚';
                        }
                    }
                }, (error) => {
                    console.error("ç›£è½è³‡æ–™å¤±æ•—:", error);
                    resultsOutputEl.textContent = `ç›£è½è³‡æ–™åº«å¤±æ•—: ${error.message}`;
                });
            }


            /**
             * è™•ç†æª”æ¡ˆä¸Šå‚³äº‹ä»¶ (åƒ…é™ç®¡ç†è€…)
             */
            async function handleFile(event) {
                const file = event.target.files[0];
                if (!file) {
                    fileNameEl.textContent = 'æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ';
                    return;
                }

                fileNameEl.textContent = `å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}`;
                resultsOutputEl.textContent = 'æ­£åœ¨è®€å–æª”æ¡ˆ...';
                
                if (!schoolDataDocRef) {
                    resultsOutputEl.textContent = 'éŒ¯èª¤ï¼šè³‡æ–™åº«å°šæœªé€£æ¥ã€‚';
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                        if (jsonData.length < 2) {
                            throw new Error("æª”æ¡ˆä¸­æ²’æœ‰è¶³å¤ çš„è³‡æ–™ (è‡³å°‘éœ€è¦æ¨™é ­åˆ—å’Œä¸€ç­†è³‡æ–™)ã€‚");
                        }

                        const tempHeaders = jsonData[0];
                        const tempDataRows = jsonData.slice(1);

                        resultsOutputEl.textContent = 'æª”æ¡ˆè®€å–å®Œç•¢ï¼Œæ­£åœ¨å„²å­˜è‡³è³‡æ–™åº«...';

                        const payload = {
                            headers: tempHeaders,
                            rows_json: JSON.stringify(tempDataRows) 
                        };

                        await setDoc(schoolDataDocRef, payload);

                        // æˆåŠŸè¨Šæ¯ã€‚
                        fileNameEl.textContent = 'è³‡æ–™å„²å­˜æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...';
                        
                    } catch (error) {
                        console.error("å„²å­˜è‡³è³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                        resultsOutputEl.textContent = `å„²å­˜å¤±æ•—ï¼š${error.message}`;
                        fileNameEl.textContent = 'å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦';
                    }
                };
                
                reader.onerror = function(e) {
                    console.error("FileReader éŒ¯èª¤:", e);
                    resultsOutputEl.textContent = 'ç„¡æ³•è®€å–æª”æ¡ˆã€‚';
                    fileNameEl.textContent = 'ç„¡æ³•è®€å–æª”æ¡ˆ';
                };
                
                reader.readAsBinaryString(file);
            }

            // --- è¨è«–å€åŠŸèƒ½å‡½å¼ ---

            /**
             * æ ¼å¼åŒ– Firebase Timestamp
             */
            function formatTimestamp(timestamp) {
                if (!timestamp) return 'æ™‚é–“ä¸è©³';
                if (timestamp instanceof Timestamp) {
                    return timestamp.toDate().toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                return 'ç„¡æ•ˆæ™‚é–“';
            }

            /**
             * ç›£è½è¨è«–å€å¸–å­åˆ—è¡¨
             */
            function listenForForumPosts() {
                if (!forumPostsRef) return;
                
                // åœæ­¢èˆŠçš„ç›£è½
                if (unsubscribeForumPosts) unsubscribeForumPosts();

                // æŒ‰ç™¼å¸–æ™‚é–“æ’åº
                const q = query(
                    forumPostsRef, 
                    orderBy('createdAt', 'desc')
                );
                
                unsubscribeForumPosts = onSnapshot(q, (snapshot) => {
                    postsCache = snapshot.docs;
                    renderFilteredPostList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                }, (error) => {
                    console.error("ç›£è½å¸–å­å¤±æ•—:", error);
                    postListContainerEl.innerHTML = `<p class="text-red-500">ç„¡æ³•è¼‰å…¥å¸–å­ï¼š${error.message}ã€‚</p>`;
                });
            }

            /**
             * å¾ localStorage è¼‰å…¥ç¯©é¸å™¨
             */
            function loadFilters() {
                try {
                    const savedFilters = localStorage.getItem('forumFilters');
                    if (savedFilters) {
                        forumFilters = JSON.parse(savedFilters);
                        forumSearchKeywordEl.value = forumFilters.keyword || '';
                        forumSearchCategoryEl.value = forumFilters.category || '';
                        forumSearchStatusEl.value = forumFilters.status || '';
                        forumSearchLinkedDeptEl.value = forumFilters.linkedDept || '';
                    }
                } catch (e) {
                    console.warn("è¼‰å…¥ç¯©é¸å™¨å¤±æ•—", e);
                    forumFilters = {};
                }
            }

            /**
             * ä¿å­˜ç¯©é¸å™¨åˆ° localStorage
             */
            function saveFilters() {
                 forumFilters = {
                    keyword: forumSearchKeywordEl.value,
                    category: forumSearchCategoryEl.value,
                    status: forumSearchStatusEl.value,
                    linkedDept: forumSearchLinkedDeptEl.value,
                };
                localStorage.setItem('forumFilters', JSON.stringify(forumFilters));
            }
            
            /**
             * æ‡‰ç”¨è¨è«–å€ç¯©é¸ä¸¦æ¸²æŸ“ (åŠ å…¥ Debounce)
             */
            const debouncedFilterHandler = debounce(() => {
                if (!postListContainerEl) return;
                
                // 1. æ›´æ–°ä¸¦ä¿å­˜ç¯©é¸å™¨
                saveFilters();
                
                console.log("æ­£åœ¨å¥—ç”¨è¨è«–å€ç¯©é¸:", forumFilters);

                // 2. å–å¾—å¿«å–
                const allPosts = postsCache;

                // 3. åŸ·è¡Œå®¢æˆ¶ç«¯ç¯©é¸
                const keyword = (forumFilters.keyword || '').toLowerCase().trim();
                const keywords = keyword.split(' ').filter(k => k); // æ”¯æ´å¤šé—œéµå­—

                const filteredDocs = allPosts.filter(doc => {
                    const post = doc.data();
                    
                    // æª¢æŸ¥é—œéµå­—
                    if (keywords.length > 0) {
                        const searchContent = [
                            post.title,
                            post.content,
                            post.authorDisplayName,
                            post.authorEmail,
                            post.linkedSchoolName,
                            post.linkedDepartmentName
                        ].join(' ').toLowerCase();
                        
                        // å¿…é ˆåŒ…å«æ‰€æœ‰é—œéµå­—
                        if (!keywords.every(k => searchContent.includes(k))) {
                            return false;
                        }
                    }
                    
                    // æª¢æŸ¥åˆ†é¡
                    if (forumFilters.category && post.category !== forumFilters.category) {
                        return false;
                    }

                    // æª¢æŸ¥ç‹€æ…‹
                    if (forumFilters.status) {
                        if (forumFilters.status === 'unreplied' && (post.replyCount || 0) > 0) {
                            return false;
                        }
                        if (forumFilters.status === 'replied' && (post.replyCount || 0) === 0) {
                            return false;
                        }
                    }

                    // æª¢æŸ¥é—œè¯æ ¡ç³»
                    if (forumFilters.linkedDept) {
                        const linkedText = `${post.linkedSchoolName || ''} - ${post.linkedDepartmentName || ''}`;
                        if (forumFilters.linkedDept !== linkedText) {
                            return false;
                        }
                    }

                    return true;
                });
                
                console.log(`ç¯©é¸å‡º ${filteredDocs.length} / ${allPosts.length} ç¯‡å¸–å­`);

                // 4. æ¸²æŸ“çµæœ
                renderPostList(filteredDocs);
            }, 300); // å»¶é² 300 æ¯«ç§’

            function renderFilteredPostList() {
                debouncedFilterHandler();
            }


            /**
             * æ¸²æŸ“å¸–å­åˆ—è¡¨ (åƒ…è² è²¬ HTML)
             */
            function renderPostList(docs) {
                if (!postListContainerEl) return;
                postListContainerEl.innerHTML = ''; // æ¸…ç©º
                if (docs.length === 0) {
                    postListContainerEl.innerHTML = '<p class="text-gray-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å¸–å­ã€‚</p>';
                    return;
                }

                docs.forEach(doc => {
                    const post = doc.data();
                    const postEl = document.createElement('div');
                    postEl.className = `post-item`;
                    
                    // å»ºç«‹æ¨™ç±¤
                    let tagsHTML = '';
                    if (post.category) {
                        tagsHTML += `<span class="post-tag tag-category">${post.category}</span>`;
                    }
                    if (post.linkedSchoolName) {
                        // é¡¯ç¤ºå®Œæ•´æ ¡ç³»
                        const linkedText = `${post.linkedSchoolName} - ${post.linkedDepartmentName}`;
                        tagsHTML += `<span class="post-tag tag-linked">${linkedText}</span>`;
                    }

                    // æ›´æ–°åˆ—è¡¨é …çš„ HTML
                    postEl.innerHTML = `
                        <div class="mb-2 flex flex-wrap">
                            ${tagsHTML}
                        </div>
                        <div class="flex justify-between items-center mb-1">
                            <a class="post-title-link">${post.title}</a>
                        </div>
                        <p class="post-meta">
                            ç”± ${post.authorDisplayName || post.authorEmail} ç™¼è¡¨æ–¼ ${formatTimestamp(post.createdAt)}
                            <span class="ml-4">å›è¦† (${post.replyCount || 0})</span>
                        </p>
                    `;
                    
                    // é»æ“Šæ¨™é¡Œé€²å…¥è©³æƒ…é 
                    postEl.querySelector('.post-title-link').addEventListener('click', () => {
                        handleShowPostDetail(doc.id);
                    });
                    
                    postListContainerEl.appendChild(postEl);
                });
            }
            
            /**
             * è™•ç†ï¼šé¡¯ç¤ºå¸–å­è©³æƒ…
             */
            function handleShowPostDetail(postId) {
                showView('detail', postId);
            }

            /**
             * è¼‰å…¥å–®ä¸€å¸–å­åŠå…¶å›è¦†
             */
            async function loadPostDetail(postId) {
                // 1. è¼‰å…¥å¸–å­ä¸»å…§å®¹
                postDetailContentEl.innerHTML = '<p class="text-gray-500">æ­£åœ¨è¼‰å…¥å¸–å­å…§å®¹...</p>';
                try {
                    const postRef = doc(db, 'forum_posts', postId);
                    const docSnap = await getDoc(postRef);

                    if (docSnap.exists()) {
                        const post = docSnap.data();
                        
                        // ç®¡ç†å“¡æŒ‰éˆ•
                        let adminBtnsHTML = '';
                        if (currentUserRole === 'admin') {
                            adminBtnsHTML = `
                                <div class="flex gap-2">
                                    <button id="delete-post-btn" class="text-sm font-medium text-red-600 hover:text-red-800 ml-4">åˆªé™¤æ­¤å¸–</button>
                                </div>
                            `;
                        }
                        
                        // æ¨™ç±¤
                        let tagsHTML = '';
                        if (post.category) tagsHTML += `<span class="post-tag tag-category">${post.category}</span>`;

                        // é—œè¯è³‡æ–™
                        let linkedDataHTML = '';
                        if (post.linkedSchoolName) {
                            linkedDataHTML = `
                                <div class="mb-4 bg-gray-50 border border-gray-200 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-700">é—œè¯è³‡æ–™</h4>
                                    <p class="text-sm text-gray-600">
                                        <strong>${post.linkedSchoolName} - ${post.linkedDepartmentName}</strong>
                                    </p>
                                    <p class="text-sm text-gray-600">112åˆ†ç™¼çµæœ: ${post.linkedData112 || 'N/A'}</p>
                                    <p class="text-sm text-gray-600">113åˆ†ç™¼çµæœ: ${post.linkedData113 || 'N/A'}</p>
                                </div>
                            `;
                        }

                        // æ›´æ–°è©³æƒ… HTML
                        postDetailContentEl.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex flex-wrap">
                                    ${tagsHTML}
                                </div>
                                ${adminBtnsHTML}
                            </div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">${post.title}</h2>
                            <p class="post-meta mb-4">
                                ç”± ${post.authorDisplayName || post.authorEmail} ç™¼è¡¨æ–¼ ${formatTimestamp(post.createdAt)}
                            </p>
                            ${linkedDataHTML}
                            <div class="post-content text-gray-700 text-base leading-relaxed">
                                ${post.content}
                            </div>
                        `;
                        
                        // ç¶å®šç®¡ç†å“¡æŒ‰éˆ•äº‹ä»¶
                        if (currentUserRole === 'admin') {
                            document.getElementById('delete-post-btn').addEventListener('click', () => handleDeletePost(postId));
                        }
                    } else {
                        postDetailContentEl.innerHTML = '<p class="text-red-500">éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é€™ç¯‡å¸–å­ã€‚</p>';
                    }
                } catch (e) {
                    console.error("è¼‰å…¥å¸–å­è©³æƒ…å¤±æ•—:", e);
                    postDetailContentEl.innerHTML = `<p class="text-red-500">è¼‰å…¥å¤±æ•—ï¼š${e.message}</p>`;
                }

                // 2. ç›£è½å›è¦†
                repliesListContainerEl.innerHTML = '<p class="text-gray-500">æ­£åœ¨è¼‰å…¥å›è¦†...</p>';
                
                // åœæ­¢ä¸Šæ¬¡çš„ç›£è½
                if (unsubscribeReplies) {
                    unsubscribeReplies();
                }

                const repliesRef = collection(db, 'forum_posts', postId, 'replies');
                
                // æŒ‰æ™‚é–“æ’åº
                const q = query(repliesRef, orderBy('createdAt', 'asc'));
                
                unsubscribeReplies = onSnapshot(q, (snapshot) => {
                    renderReplies(snapshot.docs, postId);
                }, (error) => {
                    console.error("ç›£è½å›è¦†å¤±æ•—:", error);
                    repliesListContainerEl.innerHTML = `<p class="text-red-500">ç„¡æ³•è¼‰å…¥å›è¦†ï¼š${error.message}ã€‚</p>`;
                });
            }
            
            /**
             * æ¸²æŸ“å›è¦†åˆ—è¡¨
             */
            function renderReplies(docs, postId) {
                if (!repliesListContainerEl) return;
                repliesListContainerEl.innerHTML = '';
                if (docs.length === 0) {
                    repliesListContainerEl.innerHTML = '<p class="text-gray-500">ç›®å‰å°šç„¡å›è¦†ã€‚</p>';
                    return;
                }
                
                docs.forEach(doc => {
                    const reply = doc.data();
                    const replyId = doc.id;
                    const replyEl = document.createElement('div');
                    replyEl.className = `reply-item`;
                    
                    // ç®¡ç†å“¡æŒ‰éˆ•
                    let adminBtnHTML = '';
                    if (currentUserRole === 'admin') {
                        adminBtnHTML = `
                            <button data-postid="${postId}" data-replyid="${replyId}" class="delete-reply-btn text-red-500 hover:underline text-xs ml-2">åˆªé™¤</button>
                        `;
                    }
                    
                    // æ›´æ–°å›è¦† HTML
                    replyEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="post-meta">
                                <strong>${reply.authorDisplayName || reply.authorEmail}</strong>
                                <span> å›è¦†æ–¼ ${formatTimestamp(reply.createdAt)}</span>
                            </p>
                            <div>
                                ${adminBtnHTML}
                            </div>
                        </div>
                        <p class="post-content text-gray-700">${reply.content}</p>
                    `;
                    repliesListContainerEl.appendChild(replyEl);
                });
                
                // ç¶å®šæ‰€æœ‰åˆªé™¤å›è¦†æŒ‰éˆ•
                repliesListContainerEl.querySelectorAll('.delete-reply-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        handleDeleteReply(e.currentTarget.dataset.postid, e.currentTarget.dataset.replyid);
                    });
                });
            }

            /**
             * è™•ç†ï¼šç™¼è¡¨æ–°å¸–å­
             */
            async function handleCreatePost(event) {
                event.preventDefault();
                if (!forumPostsRef || !currentUserEmail) return;
                
                const category = postCategoryEl.value;
                const title = postTitleEl.value.trim();
                const content = postContentEl.value.trim();
                
                if (!category || !title || !content) {
                    alert('ä¸»é¡Œåˆ†é¡ã€æ¨™é¡Œå’Œå…§å®¹éƒ½ä¸èƒ½ç‚ºç©ºï¼');
                    return;
                }
                
                // ç²å–é—œè¯è³‡æ–™
                const linkedDeptValue = postLinkDeptEl.value;
                let linkedData = {};
                if (linkedDeptValue) {
                    const [school, dept] = linkedDeptValue.split(' - ');
                    const row = allDataRows.find(r => 
                        r[schoolDataCache.schoolColIdx] && r[schoolDataCache.schoolColIdx].trim() === school && 
                        r[schoolDataCache.deptColIdx] && r[schoolDataCache.deptColIdx].trim() === dept
                    );
                    if (row) {
                        linkedData = {
                            linkedSchoolName: school,
                            linkedDepartmentName: dept,
                            linkedData112: row[schoolDataCache.col112Idx] || 'N/A',
                            linkedData113: row[schoolDataCache.col113Idx] || 'N/A'
                        };
                    }
                }

                
                submitPostBtn.disabled = true;
                submitPostBtn.querySelector('span:not(.hidden)').textContent = 'ç™¼ä½ˆä¸­...';

                try {
                    await addDoc(forumPostsRef, {
                        title: title,
                        content: content,
                        category: category,
                        ...linkedData, 
                        replyCount: 0,
                        createdAt: serverTimestamp(),
                        authorEmail: currentUserEmail,
                        authorDisplayName: currentUserDisplayName,
                        authorUid: userId
                    });
                    showView('main'); // è¿”å›ä¸»åˆ—è¡¨
                } catch (e) {
                    console.error("ç™¼è¡¨å¸–å­å¤±æ•—:", e);
                    alert(`ç™¼è¡¨å¤±æ•—ï¼š${e.message}`);
                } finally {
                    submitPostBtn.disabled = false;
                    submitPostBtn.querySelector('span:not(.hidden)').textContent = 'ç™¼ä½ˆ';
                }
            }
            
            /**
             * è™•ç†ï¼šç™¼è¡¨æ–°å›è¦† (ä¸¦æ›´æ–°çˆ¶å¸–å­)
             */
            async function handleCreateReply(event) {
                event.preventDefault();
                if (!currentPostId || !currentUserEmail) return;
                
                const content = replyContentEl.value.trim();
                if (!content) return;
                
                submitReplyBtn.disabled = true;
                submitReplyBtn.querySelector('span:not(.hidden)').textContent = 'é€å‡ºä¸­...';
                
                try {
                    // 1. æ–°å¢å›è¦†
                    const repliesRef = collection(db, 'forum_posts', currentPostId, 'replies');
                    await addDoc(repliesRef, {
                        content: content,
                        createdAt: serverTimestamp(),
                        authorEmail: currentUserEmail,
                        authorDisplayName: currentUserDisplayName,
                        authorUid: userId
                    });
                    
                    // 2. æ›´æ–°çˆ¶å¸–å­çš„å›è¦†æ•¸
                    const postRef = doc(db, 'forum_posts', currentPostId);
                    await updateDoc(postRef, {
                        replyCount: increment(1)
                    });
                    
                    newReplyFormEl.reset(); // æ¸…ç©ºå›è¦†æ¡†
                } catch (e) {
                    console.error("ç™¼è¡¨å›è¦†å¤±æ•—:", e);
                    alert(`å›è¦†å¤±æ•—ï¼š${e.message}`);
                } finally {
                    submitReplyBtn.disabled = false;
                    submitReplyBtn.querySelector('span:not(.hidden)').textContent = 'é€å‡ºå›è¦†';
                }
            }
            

            /**
             * è™•ç†ï¼šåˆªé™¤å¸–å­ (åƒ…é™ç®¡ç†å“¡)
             */
            async function handleDeletePost(postId) {
                if (currentUserRole !== 'admin') return;
                if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™æ•´ç¯‡å¸–å­å—ï¼Ÿ\nï¼ˆæ³¨æ„ï¼šé€™ç›®å‰ä¸æœƒè‡ªå‹•åˆªé™¤åº•ä¸‹çš„å›è¦†ï¼‰')) return;
                
                try {
                    await deleteDoc(doc(db, 'forum_posts', postId));
                    showView('main'); // è¿”å›ä¸»åˆ—è¡¨
                } catch (e) {
                    console.error("åˆªé™¤å¸–å­å¤±æ•—:", e);
                    alert(`åˆªé™¤å¤±æ•—ï¼š${e.message}`);
                }
            }
            
            /**
             * è™•ç†ï¼šåˆªé™¤å›è¦† (åƒ…é™ç®¡ç†å“¡)
             */
            async function handleDeleteReply(postId, replyId) {
                if (currentUserRole !== 'admin') return;
                if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å‰‡å›è¦†å—ï¼Ÿ')) return;
                
                try {
                    // 1. åˆªé™¤å›è¦†
                    await deleteDoc(doc(db, 'forum_posts', postId, 'replies', replyId));
                    
                    // 2. æ›´æ–°çˆ¶å¸–å­çš„å›è¦†æ•¸ (-1)
                    const postRef = doc(db, 'forum_posts', postId);
                    await updateDoc(postRef, {
                        replyCount: increment(-1)
                    });
                    // onSnapshot æœƒè‡ªå‹•æ›´æ–° UI
                } catch (e) {
                    console.error("åˆªé™¤å›è¦†å¤±æ•—:", e);
                    alert(`åˆªé™¤å¤±æ•—ï¼š${e.message}`);
                }
            }
            
            // --- ç¯©é¸å™¨å’Œ UI é‚è¼¯ ---

            /**
             * (ä¿®æ­£) å»ºç«‹å¯ç”¨çš„æ¬„ä½åˆ—è¡¨ï¼Œä¸¦ä¾ç…§æŒ‡å®šé †åºæ’åˆ—
             */
            function populateAvailableColumns() {
                // å®šç¾©æ‚¨è¦æ±‚çš„å„ªå…ˆæ’åºæ¸…å–® (æ³¨æ„: å¿…é ˆå®Œå…¨ç¬¦åˆ Excel æ¨™é ­)
                const priorityOrder = [
                    "æ ¡ç³»ä»£ç¢¼", "å­¸æ ¡", "æ ¡ç³»åç¨±",
                    // 114
                    "114åŸä½æ°‘å¤–åŠ åé¡", "114é è¨ˆé€šéä¸€éšäººæ•¸", "114é€šéä¸€éšå¤–åŠ ", "114æ­£å–äººæ•¸", "114å‚™å–äººæ•¸", "114åˆ†ç™¼çµæœ", "114åˆ†ç™¼æœ€ä½æ¨™æº–",
                    // 113
                    "113åŸä½æ°‘å¤–åŠ åé¡", "113é è¨ˆé€šéä¸€éšäººæ•¸", "113é€šéä¸€éšå¤–åŠ ", "113æ­£å–äººæ•¸", "113å‚™å–äººæ•¸", "113åˆ†ç™¼çµæœ", "113åˆ†ç™¼æœ€ä½æ¨™æº–",
                    // 112
                    "112åŸä½æ°‘å¤–åŠ åé¡", "112é è¨ˆé€šéä¸€éšäººæ•¸", "112é€šéä¸€éšå¤–åŠ ", "112æ­£å–äººæ•¸", "112å‚™å–äººæ•¸", "112åˆ†ç™¼çµæœ", "112åˆ†ç™¼æœ€ä½æ¨™æº–"
                ];

                // å…ˆå°‡åŸå§‹æ¬„ä½è½‰ç‚ºç‰©ä»¶
                let cols = allHeaders.map((header, index) => ({
                    name: (header || "").trim(),
                    index: index,
                    originalName: header || `(ç¬¬ ${index + 1} æ¬„)`
                })).filter(c => c.name !== ""); // éæ¿¾ç©ºæ¨™é ­

                // æ ¹æ“šå„ªå…ˆæ¸…å–®é€²è¡Œæ’åº
                availableColumns = cols.sort((a, b) => {
                    let indexA = priorityOrder.indexOf(a.name);
                    let indexB = priorityOrder.indexOf(b.name);

                    // å¦‚æœæ‰¾åˆ°ï¼Œä½¿ç”¨ priorityOrder çš„ç´¢å¼•
                    // å¦‚æœæ²’æ‰¾åˆ° (-1)ï¼Œçµ¦ä¸€å€‹å¾ˆå¤§çš„æ•¸å­—æ”¾åˆ°æœ€å¾Œ
                    if (indexA === -1) indexA = 9999;
                    if (indexB === -1) indexB = 9999;

                    if (indexA !== indexB) {
                        return indexA - indexB;
                    }
                    // å¦‚æœéƒ½ä¸åœ¨å„ªå…ˆæ¸…å–®ä¸­ï¼ŒæŒ‰åŸå§‹é †åºæ’
                    return a.index - b.index;
                });
            }

            /**
             * è™•ç†æ ¡ç³»è³‡æ–™å¿«å– (å»é™¤ç©ºç™½å’Œé‡è¤‡)
             */
            function processSchoolDataCache() {
                // æ‰¾åˆ°æ¬„ä½ç´¢å¼•
                schoolDataCache.schoolColIdx = allHeaders.findIndex(h => h && h.trim() === "å­¸æ ¡");
                schoolDataCache.deptColIdx = allHeaders.findIndex(h => h && h.trim() === "æ ¡ç³»åç¨±");
                schoolDataCache.col112Idx = allHeaders.findIndex(h => h && h.trim() === "112åˆ†ç™¼çµæœ");
                schoolDataCache.col113Idx = allHeaders.findIndex(h => h && h.trim() === "113åˆ†ç™¼çµæœ");

                if (schoolDataCache.schoolColIdx === -1 || schoolDataCache.deptColIdx === -1) {
                    console.warn("æ‰¾ä¸åˆ° 'å­¸æ ¡' æˆ– 'æ ¡ç³»åç¨±' æ¬„ä½ã€‚é—œè¯åŠŸèƒ½å°‡åœç”¨ã€‚");
                    schoolDataCache.linkedDeptList = [];
                    return;
                }

                const uniqueDeptSet = new Set();
                schoolDataCache.linkedDeptList = [];

                allDataRows.forEach(row => {
                    const school = row[schoolDataCache.schoolColIdx] ? row[schoolDataCache.schoolColIdx].trim() : null;
                    const dept = row[schoolDataCache.deptColIdx] ? row[schoolDataCache.deptColIdx].trim() : null;
                    
                    if (school && dept) {
                        const uniqueKey = `${school} - ${dept}`;
                        if (!uniqueDeptSet.has(uniqueKey)) {
                            uniqueDeptSet.add(uniqueKey);
                            schoolDataCache.linkedDeptList.push({
                                text: uniqueKey,
                                school: school,
                                dept: dept
                            });
                        }
                    }
                });
                
                // æ’åº
                schoolDataCache.linkedDeptList.sort((a, b) => a.text.localeCompare(b.text, 'zh-Hant'));
                console.log("æ ¡ç³»è³‡æ–™å¿«å–è™•ç†å®Œç•¢ï¼Œå…±", schoolDataCache.linkedDeptList.length, "ç­†è³‡æ–™");
            }

            /**
             * å¡«å……ç™¼å¸–è¡¨å–®å’Œç¯©é¸å™¨çš„ä¸‹æ‹‰é¸å–®
             */
            function populateLinkedSchoolDropdowns() {
                // æ¸…ç©º
                postLinkDeptEl.innerHTML = '<option value="">-- ç„¡é ˆé—œè¯ --</option>';
                forumSearchLinkedDeptEl.innerHTML = '<option value="">å…¨éƒ¨æ ¡ç³»</option>';

                if (schoolDataCache.linkedDeptList.length === 0) {
                    postLinkDeptEl.disabled = true;
                    forumSearchLinkedDeptEl.disabled = true;
                    return;
                }
                
                postLinkDeptEl.disabled = false;
                forumSearchLinkedDeptEl.disabled = false;

                const optionsHTML = schoolDataCache.linkedDeptList
                    .map(item => `<option value="${item.text}">${item.text}</option>`)
                    .join('');
                
                postLinkDeptEl.innerHTML += optionsHTML;
                forumSearchLinkedDeptEl.innerHTML += optionsHTML;
                
                // è¼‰å…¥ localStorage ä¸­å„²å­˜çš„ç¯©é¸å€¼
                loadFilters();
            }

            /**
             * ç¶å®šé—œè¯æ ¡ç³»ä¸‹æ‹‰é¸å–®çš„ change äº‹ä»¶
             */
            if (postLinkDeptEl) {
                postLinkDeptEl.addEventListener('change', () => {
                    const selectedValue = postLinkDeptEl.value;
                    if (!selectedValue) {
                        postLinkPreviewEl.classList.add('hidden');
                        return;
                    }

                    const [school, dept] = selectedValue.split(' - ');
                    const row = allDataRows.find(r => 
                        r[schoolDataCache.schoolColIdx] && r[schoolDataCache.schoolColIdx].trim() === school && 
                        r[schoolDataCache.deptColIdx] && r[schoolDataCache.deptColIdx].trim() === dept
                    );
                    
                    if (row) {
                        postLinkPreviewEl.innerHTML = `
                            <strong>é—œè¯è³‡æ–™é è¦½:</strong><br>
                            112åˆ†ç™¼çµæœ: ${row[schoolDataCache.col112Idx] || 'N/A'}<br>
                            113åˆ†ç™¼çµæœ: ${row[schoolDataCache.col113Idx] || 'N/A'}
                        `;
                        postLinkPreviewEl.classList.remove('hidden');
                    } else {
                        postLinkPreviewEl.classList.add('hidden');
                    }
                });
            }


            /**
             * é¡¯ç¤ºå‰ 12 ç­†è³‡æ–™ (ç¬¬ 2-9 æ¬„) ä½œç‚ºé è¦½
             */
            function displayInitialPreview() {
                resultsOutputEl.innerHTML = '';
                exportButtonEl.classList.add('hidden');
                currentExportData = null;

                if (allDataRows.length === 0) {
                    resultsOutputEl.textContent = 'æ²’æœ‰è³‡æ–™å¯ä¾›é è¦½ã€‚';
                    return;
                }
                if (allHeaders.length < 9) {
                    resultsOutputEl.textContent = `éŒ¯èª¤ï¼šæª”æ¡ˆæ¬„ä½ä¸è¶³ 9 æ¬„ï¼Œç„¡æ³•é¡¯ç¤ºé è¦½ã€‚`;
                    return;
                }

                const previewHeaders = allHeaders.slice(1, 9);
                const previewRows = allDataRows.slice(0, 12);
                let html = '<table class="w-full text-left border-collapse">';
                html += '<thead><tr>';
                previewHeaders.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead>';
                html += '<tbody>';
                previewRows.forEach(row => {
                    html += '<tr>';
                    for (let i = 1; i <= 8; i++) {
                        const cellData = (row[i] === null || row[i] === undefined) ? '' : row[i];
                        html += `<td>${cellData}</td>`;
                    }
                    html += '</tr>';
                });
                html += '</tbody></table>';
                resultsOutputEl.innerHTML = html;
            }
            
            /**
             * æ›´æ–°æ‰€æœ‰æ¢ä»¶çµ„çš„æ¨™é¡Œå’Œç§»é™¤æŒ‰éˆ•
             */
            function updateFilterGroupHeaders() {
                const allGroups = filterGroupsContainerEl.querySelectorAll('.filter-group');
                allGroups.forEach((group, index) => {
                    const isFirst = (index === 0);
                    
                    // 1. å°‹æ‰¾æˆ–å»ºç«‹æ¨™é ­å®¹å™¨
                    let headerEl = group.querySelector('.filter-group-header');
                    if (!headerEl) {
                        headerEl = document.createElement('div');
                        headerEl.className = 'filter-group-header';
                        group.prepend(headerEl); // æ’å…¥åˆ°å¡ç‰‡æœ€é ‚éƒ¨
                    }

                    // 2. ç”¢ç”Ÿæ¨™é ­ HTML
                    let headerHTML = '';
                    if (!isFirst) {
                        // æ¢ä»¶ 2+ : åŒ…å«é‚è¼¯
                        const existingLogicSelect = group.querySelector('.filter-logic');
                        const currentLogic = existingLogicSelect ? existingLogicSelect.value : 'AND';

                        headerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <select class="filter-logic w-auto p-2 form-input-style">
                                    <option value="AND" ${currentLogic === 'AND' ? 'selected' : ''}>AND (ä¸”)</option>
                                    <option value="OR" ${currentLogic === 'OR' ? 'selected' : ''}>OR (æˆ–)</option>
                                </select>
                                <span class="text-lg font-semibold text-gray-700">ğŸ” æ¢ä»¶ ${index + 1}</span>
                            </div>
                        `;
                    } else {
                        // æ¢ä»¶ 1 : åªæœ‰æ¨™é¡Œ
                        headerHTML = `<h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ” æ¢ä»¶ ${index + 1}</h3>`;
                    }
                    headerEl.innerHTML = headerHTML;

                    // 3. æ›´æ–°ç§»é™¤æŒ‰éˆ•çš„å¯è¦‹æ€§
                    const removeBtn = group.querySelector('.remove-filter-btn');
                    if (removeBtn) {
                        if (isFirst && allGroups.length === 1) {
                            removeBtn.classList.add('hidden'); // åªæœ‰ä¸€å¼µå¡ç‰‡ï¼Œéš±è—
                        } else if (isFirst && allGroups.length > 1) {
                             removeBtn.classList.add('hidden'); // æ˜¯ç¬¬ä¸€å¼µå¡ç‰‡(ä¸”ä¸åªä¸€å¼µ)ï¼Œéš±è—
                        } else {
                            removeBtn.classList.remove('hidden'); // ä¸æ˜¯ç¬¬ä¸€å¼µå¡ç‰‡ï¼Œé¡¯ç¤º
                        }
                    }
                });

                // å‚™ç”¨ï¼šå¦‚æœåªæœ‰ä¸€å¼µå¡ï¼Œç¢ºä¿å…¶ç§»é™¤æŒ‰éˆ•æ˜¯éš±è—çš„
                if (allGroups.length === 1) {
                     const removeBtn = allGroups[0].querySelector('.remove-filter-btn');
                     if(removeBtn) removeBtn.classList.add('hidden');
                }
            }


            /**
             * æ–°å¢ä¸€å€‹æ¢ä»¶çµ„
             */
            function addFilterGroup(logic = 'AND') {
                const groupWrapper = document.createElement('div');
                groupWrapper.className = 'filter-group bg-white p-4 rounded-xl shadow-md';
                
                // æ¨™é ­(Header)å°‡ç”± updateFilterGroupHeaders å‡½å¼è™•ç†
                const headerContainer = document.createElement('div');
                headerContainer.className = 'filter-group-header';
                groupWrapper.appendChild(headerContainer); // å…ˆåŠ ä¸€å€‹ç©ºçš„

                // HTML çµæ§‹
                const groupHTML = `
                    <!-- ç¬¬ä¸€è¡Œï¼šæ¬„ä½ã€é‹ç®—å­ã€æ¯”è¼ƒå°è±¡ã€ç§»é™¤ -->
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <!-- æ¬„ä½é¸æ“‡ -->
                        <div class="md:col-span-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1">æ¬„ä½ (å·¦)</label>
                            <select class="filter-column w-full p-2 form-input-style">
                                <option value="">-- é¸æ“‡æ¬„ä½ --</option>
                                ${availableColumns.map(col => `<option value="${col.index}">${col.originalName}</option>`).join('')}
                            </select>
                        </div>
                        <!-- é‹ç®—å­ -->
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-600 mb-1">é‹ç®—å­</label>
                            <select class="filter-operator w-full p-2 form-input-style">
                                <option value="contains">åŒ…å«</option>
                                <option value="not_contains">ä¸åŒ…å«</option>
                                <option value="equals">ï¼ (ç­‰æ–¼)</option>
                                <option value="not_equals">â‰  (ä¸ç­‰æ–¼)</option>
                                <option value="gt">ï¼ (å¤§æ–¼)</option>
                                <option value="lt">ï¼œ (å°æ–¼)</option>
                                <option value="gte">â‰¥ (å¤§æ–¼ç­‰æ–¼)</option>
                                <option value="lte">â‰¤ (å°æ–¼ç­‰æ–¼)</option>
                                <option value="between">ä»‹æ–¼</option>
                            </select>
                        </div>
                        <!-- æ¯”è¼ƒå°è±¡ (å›ºå®šå€¼/æ¬„ä½) -->
                        <div class="md:col-span-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1">æ¯”è¼ƒå°è±¡ (å³)</label>
                            <select class="filter-target-type w-full p-2 form-input-style transition-colors duration-200">
                                <option value="value">å›ºå®šå€¼</option>
                                <option value="column">æ¬„ä½</option>
                            </select>
                        </div>
                        <!-- ç§»é™¤æŒ‰éˆ• -->
                        <div class="md:col-span-1 flex items-end">
                            <button class="remove-filter-btn text-gray-400 hover:text-red-500 transition duration-300 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- ç¬¬äºŒè¡Œï¼šå€¼è¼¸å…¥å€åŸŸ -->
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-4">
                        <!-- å€¼ 1 (å›ºå®šå€¼) -->
                        <div class="filter-value-1-wrapper md:col-span-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1">å€¼</label>
                            <input type="text" class="filter-value-1 w-full p-2 form-input-style" placeholder="è¼¸å…¥å€¼...">
                        </div>
                        <!-- å€¼ 2 (ä»‹æ–¼) -->
                        <div class="filter-value-2-wrapper md:col-span-4 hidden-strict">
                            <label class="block text-sm font-medium text-gray-600 mb-1">è‡³</label>
                            <input type="text" class="filter-value-2 w-full p-2 form-input-style" placeholder="è¼¸å…¥å€¼...">
                        </div>
                        <!-- å€¼ (æ¬„ä½) -->
                        <div class="filter-value-column-wrapper md:col-span-4 hidden-strict">
                            <label class="block text-sm font-medium text-gray-600 mb-1">é¸æ“‡æ¬„ä½</label>
                            <select class="filter-value-column w-full p-2 form-input-style">
                                <option value="">-- é¸æ“‡æ¬„ä½ --</option>
                                ${availableColumns.map(col => `<option value="${col.index}">${col.originalName}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
                
                // å»ºç«‹ä¸€å€‹å®¹å™¨ä¾†æ”¾ form
                const formContainer = document.createElement('div');
                formContainer.innerHTML = groupHTML;
                groupWrapper.appendChild(formContainer);

                // å‹•ç•«ï¼šæ·¡å…¥
                groupWrapper.classList.add('filter-group-enter');
                filterGroupsContainerEl.appendChild(groupWrapper);
                // è§¸ç™¼ CSS å‹•ç•«
                setTimeout(() => {
                    groupWrapper.classList.remove('filter-group-enter');
                }, 10); // çŸ­æš«å»¶é²ä»¥è§¸ç™¼ transition

                // ç¶å®šæ–°æŒ‰éˆ•çš„äº‹ä»¶
                groupWrapper.querySelector('.remove-filter-btn').addEventListener('click', (e) => {
                    removeFilterGroup(e.currentTarget);
                });
                // ç¶å®šé‹ç®—å­ change äº‹ä»¶
                const operatorSelect = groupWrapper.querySelector('.filter-operator');
                operatorSelect.addEventListener('change', (e) => {
                    updateOperatorInputs(e.currentTarget);
                });
                // ç¶å®šæ¯”è¼ƒå°è±¡ change äº‹ä»¶
                const targetTypeSelect = groupWrapper.querySelector('.filter-target-type');
                targetTypeSelect.addEventListener('change', (e) => {
                    updateTargetTypeInputs(e.currentTarget);
                });

                // è§¸ç™¼ä¸€æ¬¡ï¼Œç¢ºä¿åˆå§‹ UI æ­£ç¢º
                updateOperatorInputs(operatorSelect);
                
                // æœ€å¾Œï¼Œæ›´æ–°æ‰€æœ‰æ¨™é ­
                updateFilterGroupHeaders();
            }

            /**
             * ç§»é™¤ä¸€å€‹æ¢ä»¶çµ„
             */
            function removeFilterGroup(removeButton) {
                const groupWrapper = removeButton.closest('.filter-group');
                // å‹•ç•«ï¼šæ·¡å‡º
                groupWrapper.classList.add('filter-group-exit');
                groupWrapper.addEventListener('transitionend', () => {
                    groupWrapper.remove();
                    // ç§»é™¤å¾Œï¼Œæ›´æ–°æ‰€æœ‰æ¨™é ­
                    updateFilterGroupHeaders();
                }, { once: true });
            }

            /**
             * æ ¹æ“šé‹ç®—å­æ›´æ–° UI
             */
            function updateOperatorInputs(operatorSelect) {
                const groupWrapper = operatorSelect.closest('.filter-group');
                const value1Wrapper = groupWrapper.querySelector('.filter-value-1-wrapper');
                const value2Wrapper = groupWrapper.querySelector('.filter-value-2-wrapper');
                const targetTypeSelect = groupWrapper.querySelector('.filter-target-type');
                
                const op = operatorSelect.value;

                if (op === 'contains' || op === 'not_contains' || op === 'between') {
                    // åŒ…å«/ä»‹æ–¼ï¼šå¼·åˆ¶å›ºå®šå€¼, åœç”¨ "æ¯”è¼ƒå°è±¡" ä¸‹æ‹‰é¸å–®
                    targetTypeSelect.disabled = true;
                    targetTypeSelect.value = 'value'; // å¼·åˆ¶è¨­ç‚º value
                } else {
                    // ç­‰æ–¼, ä¸ç­‰æ–¼, å¤§æ–¼, å°æ–¼...ï¼šå…è¨±åˆ‡æ›
                    targetTypeSelect.disabled = false;
                }

                // æ ¹æ“š "ä»‹æ–¼" é¡¯ç¤º/éš±è— å€¼2
                if (op === 'between') {
                    value2Wrapper.classList.remove('hidden-strict');
                } else {
                    value2Wrapper.classList.add('hidden-strict');
                }

                // ç¸½æ˜¯è§¸ç™¼ target type select çš„ change äº‹ä»¶
                updateTargetTypeInputs(targetTypeSelect);
            }

            /**
             * æ ¹æ“šæ¯”è¼ƒå°è±¡æ›´æ–° UI
             */
            function updateTargetTypeInputs(targetTypeSelect) {
                const groupWrapper = targetTypeSelect.closest('.filter-group');
                const value1Wrapper = groupWrapper.querySelector('.filter-value-1-wrapper');
                const valueColumnWrapper = groupWrapper.querySelector('.filter-value-column-wrapper');
                const value2Wrapper = groupWrapper.querySelector('.filter-value-2-wrapper');
                const operatorSelect = groupWrapper.querySelector('.filter-operator');

                if (targetTypeSelect.value === 'column') {
                    value1Wrapper.classList.add('hidden-strict');
                    valueColumnWrapper.classList.remove('hidden-strict');
                    value2Wrapper.classList.add('hidden-strict'); 
                } else { // 'value'
                    value1Wrapper.classList.remove('hidden-strict');
                    valueColumnWrapper.classList.add('hidden-strict');
                    // åƒ…ç•¶é‹ç®—å­æ˜¯ 'between' æ™‚æ‰é¡¯ç¤º å€¼2
                    if (operatorSelect.value === 'between') {
                         value2Wrapper.classList.remove('hidden-strict');
                    } else {
                         value2Wrapper.classList.add('hidden-strict');
                    }
                }
            }
            
            /**
             * æ¸…é™¤æ‰€æœ‰æ¢ä»¶çµ„
             */
            function clearAllFilters(showPreview = true) {
                filterGroupsContainerEl.innerHTML = '';
                // åªæœ‰åœ¨æœ‰æ¬„ä½å¯é¸æ™‚æ‰æ–°å¢
                if(availableColumns.length > 0) {
                     addFilterGroup(); // æ–°å¢ç¬¬ä¸€å€‹é è¨­ç¾¤çµ„
                }
                
                if (showPreview && allDataRows.length > 0) {
                    displayInitialPreview(); // é¡¯ç¤ºé è¦½
                } else if (currentUserRole === 'admin' && allDataRows.length === 0) {
                    resultsOutputEl.innerHTML = 'è³‡æ–™åº«ç‚ºç©ºæˆ–è³‡æ–™å·²æ¸…é™¤ã€‚è«‹ä¸Šå‚³æª”æ¡ˆã€‚';
                } else if (currentUserRole === 'user' && allDataRows.length === 0) {
                     resultsOutputEl.innerHTML = 'ç›®å‰è³‡æ–™åº«ä¸­æ²’æœ‰è³‡æ–™ã€‚è«‹ç­‰å¾…ç®¡ç†è€…ä¸Šå‚³ã€‚';
                } else if (!currentUserRole) {
                    resultsOutputEl.innerHTML = 'è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥...'; // ç™»å‡ºæ™‚
                }

                exportButtonEl.classList.add('hidden');
                currentExportData = null;
                updateFilterChips(); // æ¸…é™¤æ¨™ç±¤
            }

            /**
             * æª¢æŸ¥å–®ä¸€æ¢ä»¶æ˜¯å¦æ»¿è¶³
             */
            function checkCondition(row, filter) {
                const { colIndex, operator, targetType, val1, val2, valueColIndex } = filter;

                if (colIndex === "") return true; // æœªé¸æ“‡å·¦å´æ¬„ä½

                // å–å¾—å·¦å´å€¼
                const leftVal = (row[colIndex] === null || row[colIndex] === undefined) ? '' : row[colIndex];

                try {
                    // --- æƒ…æ³ 1ï¼šæ¯”è¼ƒå°åƒæ˜¯ã€Œå›ºå®šå€¼ã€---
                    if (targetType === 'value') {
                        if (val1 === "") return true; // æœªè¼¸å…¥å€¼

                        const leftValStr = String(leftVal).toLowerCase();
                        const val1Str = String(val1).toLowerCase();
                        const leftValNum = parseFloat(leftVal);
                        const val1Num = parseFloat(val1);
                        const val2Num = parseFloat(val2);
                        const isNumeric = !isNaN(leftValNum) && !isNaN(val1Num);

                        switch (operator) {
                            case 'contains':
                                return leftValStr.includes(val1Str);
                            case 'not_contains':
                                return !leftValStr.includes(val1Str);
                            case 'equals':
                                return isNumeric ? leftValNum === val1Num : leftValStr === val1Str;
                            case 'not_equals':
                                return isNumeric ? leftValNum !== val1Num : leftValStr !== val1Str;
                            case 'gt':
                                return isNumeric ? leftValNum > val1Num : leftValStr > val1Str;
                            case 'lt':
                                return isNumeric ? leftValNum < val1Num : leftValStr < val1Str;
                            case 'gte':
                                return isNumeric ? leftValNum >= val1Num : leftValStr >= val1Str;
                            case 'lte':
                                return isNumeric ? leftValNum <= val1Num : leftValStr <= val1Str;
                            case 'between':
                                if (val2 === "") return true; // ç¬¬äºŒå€‹å€¼ç‚ºç©º
                                if (isNumeric && !isNaN(val2Num)) {
                                    return leftValNum >= Math.min(val1Num, val2Num) && leftValNum <= Math.max(val1Num, val2Num);
                                }
                                // å­—ä¸²ä»‹æ–¼
                                const [minStr, maxStr] = [val1Str, String(val2).toLowerCase()].sort();
                                return leftValStr >= minStr && leftValStr <= maxStr;
                            default:
                                return true;
                        }
                    }
                    // --- æƒ…æ³ 2ï¼šæ¯”è¼ƒå°åƒæ˜¯ã€Œæ¬„ä½ã€---
                    else if (targetType === 'column') {
                        if (valueColIndex === "") return true; // æœªé¸æ“‡å³å´æ¬„ä½

                        // å–å¾—å³å´å€¼
                        const rightVal = (row[valueColIndex] === null || row[valueColIndex] === undefined) ? '' : row[valueColIndex];

                        const leftValStr = String(leftVal).toLowerCase();
                        const rightValStr = String(rightVal).toLowerCase();
                        const leftValNum = parseFloat(leftVal);
                        const rightValNum = parseFloat(rightVal);
                        const isNumeric = !isNaN(leftValNum) && !isNaN(rightValNum);

                        switch (operator) {
                            case 'equals':
                                return isNumeric ? leftValNum === rightValNum : leftValStr === rightValStr;
                            case 'not_equals':
                                return isNumeric ? leftValNum !== rightValNum : leftValStr !== rightValStr;
                            case 'gt':
                                return isNumeric ? leftValNum > rightValNum : leftValStr > rightValStr;
                            case 'lt':
                                return isNumeric ? leftValNum < rightValNum : leftValStr < rightValStr;
                            case 'gte':
                                return isNumeric ? leftValNum >= rightValNum : leftValStr >= rightValStr;
                            case 'lte':
                                return isNumeric ? leftValNum <= rightValNum : leftValStr <= rightValStr;
                            default:
                                return true;
                        }
                    }
                } catch (e) {
                    console.warn("Check condition error:", e);
                    return true; // å‡ºéŒ¯æ™‚ï¼Œæ”¾è¡Œ
                }
                return true; // é è¨­æ”¾è¡Œ
            }


            /**
             * å¥—ç”¨ç¯©é¸å™¨
             */
            function applyFilter() {
                // 1. å¾ DOM è®€å–ä¸¦å»ºç«‹ç¯©é¸å™¨ç‹€æ…‹
                activeFilters = [];
                const groupElements = filterGroupsContainerEl.querySelectorAll('.filter-group');
                
                groupElements.forEach((group, index) => {
                    const colEl = group.querySelector('.filter-column');
                    const opEl = group.querySelector('.filter-operator');
                    const targetTypeEl = group.querySelector('.filter-target-type');
                    const val1El = group.querySelector('.filter-value-1');
                    const val2El = group.querySelector('.filter-value-2');
                    const valColEl = group.querySelector('.filter-value-column');
                    const logicEl = group.querySelector('.filter-logic');
                    
                    if (!colEl) return; 

                    const targetType = targetTypeEl.value;
                    let isValid = false;
                    

                    if (targetType === 'value') {
                        // ä¹Ÿè¦æª¢æŸ¥ 'ä»‹æ–¼' çš„ val2
                        if (opEl.value === 'between') {
                            isValid = colEl.value && val1El.value && val2El.value;
                        } else {
                            isValid = colEl.value && val1El.value; // å¿…é ˆæœ‰æ¬„ä½å’Œå€¼1
                        }
                    } else { // targetType === 'column'
                        isValid = colEl.value && valColEl.value; // å¿…é ˆæœ‰æ¬„ä½å’Œå€¼æ¬„ä½
                    }

                    if (isValid) {
                        activeFilters.push({
                            id: `filter-${Date.now()}-${index}`, // å”¯ä¸€ ID
                            colIndex: colEl.value,
                            colName: colEl.options[colEl.selectedIndex].text,
                            operator: opEl.value,
                            operatorName: opEl.options[opEl.selectedIndex].text,
                            targetType: targetType,
                            val1: val1El.value,
                            val2: val2El ? val2El.value : '',
                            valueColIndex: valColEl.value,
                            valueColName: valColEl.value ? valColEl.options[valColEl.selectedIndex].text : '',
                            logic: (index === 0) ? 'START' : (logicEl ? logicEl.value : 'AND')
                        });
                    }
                });

                // 2. æ›´æ–°ç¯©é¸æ¢ä»¶æ¨™ç±¤
                updateFilterChips();

                // 3. åŸ·è¡Œç¯©é¸
                let filteredRows;
                if (activeFilters.length === 0) {
                    // å¦‚æœæ²’æœ‰'æœ‰æ•ˆ'ç¯©é¸ï¼Œä½†ä½¿ç”¨è€…å¯èƒ½æœ‰é»æ“ŠæŒ‰éˆ•ï¼Œé¡¯ç¤ºå…¨éƒ¨
                    // (æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦'è©¦åœ–'ç¯©é¸)
                    const hasInput = Array.from(groupElements).some(g => {
                        const colEl = g.querySelector('.filter-column');
                        const val1El = g.querySelector('.filter-value-1');
                        const valColEl = g.querySelector('.filter-value-column');
                        return (colEl && colEl.value) || (val1El && val1El.value) || (valColEl && valColEl.value);
                    });
                    
                    if (hasInput) {
                        // ä½¿ç”¨è€…æœ‰è¼¸å…¥ï¼Œä½†æ¢ä»¶ä¸å®Œæ•´
                        filteredRows = []; // é¡¯ç¤º'æ‰¾ä¸åˆ°'
                    } else {
                        // ä½¿ç”¨è€…æœªè¼¸å…¥ä»»ä½•æ±è¥¿ï¼Œé¡¯ç¤ºå…¨éƒ¨
                        filteredRows = allDataRows;
                    }

                } else {
                    filteredRows = allDataRows.filter(row => {
                        if (!row) return false;

                        let finalResult = null; // æœ€çµ‚çµæœ

                        for (const filter of activeFilters) {
                            const groupResult = checkCondition(row, filter);

                            if (finalResult === null) {
                                finalResult = groupResult; // ç¬¬ä¸€å€‹æ¢ä»¶
                            } else {
                                if (filter.logic === 'AND') {
                                    finalResult = finalResult && groupResult;
                                } else { // OR
                                    finalResult = finalResult || groupResult;
                                }
                            }
                        }
                        return finalResult;
                    });
                }

                // 4. é¡¯ç¤ºæ ¼å¼åŒ–å¾Œçš„çµæœ
                displayResults(filteredRows);
            }

            /**
             * (é‡å¯«) é¡¯ç¤ºç¯©é¸å¾Œçš„çµæœ (é–å®šæ¬„ä½)
             */
            function displayResults(rows, message = null) {
                resultsOutputEl.innerHTML = ''; // æ¸…ç©ºçµæœ
                exportButtonEl.classList.add('hidden');
                currentExportData = null;

                if (message) {
                    resultsOutputEl.textContent = message;
                    return;
                }

                if(allHeaders.length === 0) return;

                // (ä¿®æ”¹) æŒ‡å®šè¦é¡¯ç¤ºçš„ 6 å€‹æ¬„ä½
                const colNames = [
                    "å­¸æ ¡", 
                    "æ ¡ç³»åç¨±", 
                    "114åŸä½æ°‘å¤–åŠ åé¡", 
                    "114æ­£å–äººæ•¸", 
                    "113åŸä½æ°‘å¤–åŠ åé¡", 
                    "113æ­£å–äººæ•¸"
                ];
                
                const colIndices = [];
                const missingCols = [];
                
                colNames.forEach(name => {
                    const trimmedName = name.trim();
                    const index = allHeaders.findIndex(header => 
                        (header === null || header === undefined) ? false : header.trim() === trimmedName
                    );
                    if (index !== -1) {
                        colIndices.push(index);
                    } else {
                        missingCols.push(name);
                    }
                });

                if (missingCols.length > 0) {
                    resultsOutputEl.textContent = `éŒ¯èª¤ï¼šæª”æ¡ˆä¸­ç¼ºå°‘ä»¥ä¸‹å¿…è¦æ¬„ä½ï¼š${missingCols.join('ã€')}`;
                    return;
                }

                if (rows.length === 0) {
                    if(activeFilters.length > 0) {
                        resultsOutputEl.textContent = 'æ‰¾ä¸åˆ°ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™ã€‚';
                    } else {
                        resultsOutputEl.textContent = 'è³‡æ–™ç‚ºç©ºæˆ–æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚';
                    }
                    return;
                }

                // --- æº–å‚™åŒ¯å‡ºè³‡æ–™ (ä½¿ç”¨æ‰€æœ‰æ¬„ä½) ---
                currentExportData = [allHeaders, ...rows];

                // å»ºç«‹ HTML è¡¨æ ¼
                let html = '<table class="w-full text-left border-collapse">';
                html += '<thead><tr>';
                colNames.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead>';
                html += '<tbody>';
                rows.forEach(row => {
                    if (!row) return;
                    html += '<tr>';
                    colIndices.forEach(idx => {
                        const cellData = (row[idx] === null || row[idx] === undefined) ? '' : row[idx];
                        html += `<td>${cellData}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                
                resultsOutputEl.innerHTML = html;
                exportButtonEl.classList.remove('hidden');
            }

            /**
             * æ›´æ–°ç¯©é¸æ¢ä»¶æ¨™ç±¤ (Chips)
             */
            function updateFilterChips() {
                filterChipsContainerEl.innerHTML = '';
                if (activeFilters.length === 0) {
                    filterChipsContainerEl.classList.add('hidden');
                    return;
                }

                filterChipsContainerEl.classList.remove('hidden');
                
                activeFilters.forEach((filter, index) => {
                    let text = '';
                    if (filter.targetType === 'column') {
                        text = `<strong>${filter.colName}</strong> ${filter.operatorName} <strong>${filter.valueColName}</strong>`;
                    } else { // 'value'
                        text = `<strong>${filter.colName}</strong> ${filter.operatorName} "<strong>${filter.val1}</strong>"`;
                        if (filter.operator === 'between' && filter.val2) {
                            text += ` å’Œ "<strong>${filter.val2}</strong>"`;
                        }
                    }


                    if (index > 0) {
                        const logicChip = document.createElement('span');
                        logicChip.className = "text-sm font-semibold text-blue-600 px-2 py-1";
                        logicChip.textContent = filter.logic;
                        filterChipsContainerEl.appendChild(logicChip);
                    }
                    
                    const chip = document.createElement('div');
                    chip.className = "bg-blue-500 text-white text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2";
                    chip.innerHTML = `
                        <span>${text}</span>
                        <button data-filter-id="${filter.id}" class="remove-chip-btn text-blue-100 hover:text-white font-bold">&times;</button>
                    `;
                    filterChipsContainerEl.appendChild(chip);
                });

                // ç¶å®šæ‰€æœ‰ chip ç§»é™¤æŒ‰éˆ•çš„äº‹ä»¶
                filterChipsContainerEl.querySelectorAll('.remove-chip-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        removeFilterChip(e.currentTarget.dataset.filterId);
                    });
                });
            }

            /**
             * æ ¹æ“š ID ç§»é™¤ä¸€å€‹ç¯©é¸æ¢ä»¶ (å¾ Chip è§¸ç™¼)
             */
            function removeFilterChip(filterId) {
                // å¾ DOM ä¸­æ‰¾åˆ°å°æ‡‰çš„ group ä¸¦ç§»é™¤
                const filterIndex = activeFilters.findIndex(f => f.id === filterId);
                if (filterIndex === -1) return;

                const groupElements = filterGroupsContainerEl.querySelectorAll('.filter-group');
                if (groupElements[filterIndex]) {
                    const removeBtn = groupElements[filterIndex].querySelector('.remove-filter-btn');
                    if (removeBtn) {
                        removeFilterGroup(removeBtn);
                    }

                    setTimeout(() => {
                        applyFilter();
                    }, 350); // ç­‰å¾…å‹•ç•«æ™‚é–“
                }
            }


            /**
             * (æ›´æ–°) åŒ¯å‡ºçµæœ (XLSX) - ä¾ç…§ç‰¹å®šé †åº
             */
            function exportResults() {
                if (!currentExportData || currentExportData.length <= 1) {
                    console.warn("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºã€‚");
                    return;
                }

                // 1. å®šç¾©å¸Œæœ›è¼¸å‡ºçš„æ¬„ä½é †åº
                const targetHeaders = [
                    "æ ¡ç³»ä»£ç¢¼", "å­¸æ ¡", "æ ¡ç³»åç¨±",
                    "114åŸä½æ°‘å¤–åŠ åé¡", "114é è¨ˆé€šéä¸€éšäººæ•¸", "114é€šéä¸€éšå¤–åŠ ", "114æ­£å–äººæ•¸", "114å‚™å–äººæ•¸", "114åˆ†ç™¼çµæœ", "114åˆ†ç™¼æœ€ä½æ¨™æº–",
                    "113åŸä½æ°‘å¤–åŠ åé¡", "113é è¨ˆé€šéä¸€éšäººæ•¸", "113é€šéä¸€éšå¤–åŠ ", "113æ­£å–äººæ•¸", "113å‚™å–äººæ•¸", "113åˆ†ç™¼çµæœ", "113åˆ†ç™¼æœ€ä½æ¨™æº–",
                    "112åŸä½æ°‘å¤–åŠ åé¡", "112é è¨ˆé€šéä¸€éšäººæ•¸", "112é€šéä¸€éšå¤–åŠ ", "112æ­£å–äººæ•¸", "112å‚™å–äººæ•¸", "112åˆ†ç™¼çµæœ", "112åˆ†ç™¼æœ€ä½æ¨™æº–"
                ];

                // 2. æ‰¾å‡ºæ¯å€‹ç›®æ¨™æ¬„ä½åœ¨åŸå§‹è³‡æ–™ (allHeaders) ä¸­çš„ç´¢å¼•
                const colIndices = targetHeaders.map(target => {
                    return allHeaders.findIndex(h => h && h.trim() === target);
                });

                // 3. é‡çµ„è³‡æ–™
                // currentExportData[0] æ˜¯æ¨™é¡Œåˆ— (ä¸ä½¿ç”¨)ï¼Œ[1]... æ˜¯è³‡æ–™åˆ—
                const sourceRows = currentExportData.slice(1);
                
                const finalExportData = [];
                
                // åŠ å…¥æ–°çš„æ¨™é¡Œåˆ—
                finalExportData.push(targetHeaders);

                // è™•ç†æ¯ä¸€åˆ—è³‡æ–™
                sourceRows.forEach(row => {
                    const newRow = colIndices.map(index => {
                        // å¦‚æœåœ¨åŸå§‹è³‡æ–™ä¸­æ‰¾ä¸åˆ°è©²æ¬„ä½ (-1)ï¼Œå¡«å…¥ç©ºå­—ä¸²
                        if (index === -1) return "";
                        return (row[index] === null || row[index] === undefined) ? "" : row[index];
                    });
                    finalExportData.push(newRow);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(finalExportData);
                
                // (é¸ç”¨) è¨­ç½®æ¬„å¯¬
                try {
                    const colsToProcess = Math.min(finalExportData[0].length, 30);
                    const colWidths = [];
                    for(let i = 0; i < colsToProcess; i++) {
                        let maxLen = (finalExportData[0][i] || '').length;
                        // å–å‰ 100 ç­†è³‡æ–™ä¾†ä¼°ç®—å¯¬åº¦ï¼Œé¿å…æ•ˆèƒ½å•é¡Œ
                        for (let j = 1; j < Math.min(finalExportData.length, 101); j++) {
                            const len = (finalExportData[j][i] || '').toString().length;
                            if (len > maxLen) maxLen = len;
                        }
                        const chineseChars = (finalExportData[0][i].match(/[\u4e00-\u9fa5]/g) || []).length;
                        let adjustedMaxLen = maxLen + chineseChars;
                        adjustedMaxLen = Math.max(adjustedMaxLen, 10);
                        adjustedMaxLen = Math.min(adjustedMaxLen, 50);
                        colWidths.push({ wch: adjustedMaxLen });
                    }
                    ws['!cols'] = colWidths;
                } catch (e) {
                    console.warn("è¨ˆç®—æ¬„å¯¬æ™‚ç™¼ç”ŸéŒ¯èª¤", e);
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ç¯©é¸çµæœ");
                try {
                    XLSX.writeFile(wb, "å‡å­¸è³‡æ–™_ç¯©é¸çµæœ.xlsx");
                } catch (e) {
                    console.error("åŒ¯å‡ºæª”æ¡ˆå¤±æ•—:", e);
                    alert("åŒ¯å‡ºæª”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤ã€‚");
                }
            }

            // ç¶å®šäº‹ä»¶
            
            // æª”æ¡ˆä¸Šå‚³
            if(fileInputEl) fileInputEl.addEventListener('change', handleFile);

            // ç¯©é¸å™¨æŒ‰éˆ•
            if(filterButtonEl) filterButtonEl.addEventListener('click', applyFilter);
            if(exportButtonEl) exportButtonEl.addEventListener('click', exportResults);
            if(addFilterBtnEl) addFilterBtnEl.addEventListener('click', () => addFilterGroup());
            if(clearFiltersBtnEl) clearFiltersBtnEl.addEventListener('click', () => clearAllFilters(true));

            // è¨è«–å€ UI ç¶å®š
            if(showNewPostFormBtn) showNewPostFormBtn.addEventListener('click', () => showView('new-post'));
            if(cancelPostBtn) cancelPostBtn.addEventListener('click', () => showView('main'));
            if(backToMainBtn1) backToMainBtn1.addEventListener('click', () => showView('main'));
            if(backToMainBtn2) backToMainBtn2.addEventListener('click', () => showView('main'));
            if(newPostFormEl) newPostFormEl.addEventListener('submit', handleCreatePost);
            if(newReplyFormEl) newReplyFormEl.addEventListener('submit', handleCreateReply);
            
            // ç•™è¨€æ¿é–‹é—œ
            if(forumToggle) forumToggle.addEventListener('change', toggleForumStatus);

            // è¨è«–å€ç¯©é¸å™¨äº‹ä»¶ (ç¶å®š debounce ç‰ˆæœ¬çš„å‡½å¼)
            forumFilterInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', renderFilteredPostList);
                    input.addEventListener('change', renderFilteredPostList); // ç¢ºä¿ select ä¹Ÿè§¸ç™¼
                }
            });

            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', signInWithGoogle);
            }
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (auth) {
                        await signOut(auth); // è§¸ç™¼ onAuthStateChanged
                    }
                });
            }


            // å•Ÿå‹• Firebase åˆå§‹åŒ–
            initializeAppAndAuth();
        
        }); // çµæŸ DOMContentLoaded
    </script>

</body>
</html>
```