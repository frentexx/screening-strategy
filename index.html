<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡å­¸è³‡æ–™ç¯©é¸ç­–ç•¥</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ SheetJS (xlsx) å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- (*** ä¿®æ”¹ ***) æ›´æ–° Firebase SDK (åŒ…å« Google Auth) -->
    <!-- (*** ä¿®æ­£ ***) ä¿®æ­£ type="module" æ‹¼å¯«éŒ¯èª¤ -->
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js"></script>

    <!-- 
      è¼‰å…¥å­—é«”ï¼š
      1. Poppins (åœ“è§’æ„Ÿ, ç”¨æ–¼æ¨™é¡Œå’ŒæŒ‰éˆ•)
      2. Noto Sans TC (ç¹é«”ä¸­æ–‡å‚™æ´)
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ğŸ¨ é’æ˜¥ç§‘æŠ€æ„Ÿ UI é¢¨æ ¼ ğŸ¨ --- */

        /* 1. æ•´é«”å­—é«”è¨­å®š */
        body {
            /* å„ªå…ˆä½¿ç”¨ Poppinsï¼Œå‚™æ´ä½¿ç”¨ Noto Sans TC */
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: #F7F9FB; /* æ·ºç°èƒŒæ™¯ */
            color: #1F2937; /* é è¨­æ·±è‰²æ–‡å­— */
        }
        h1, h2, h3, button, .font-heading {
             font-family: 'Poppins', 'Noto Sans TC', sans-serif;
        }

        /* 2. è‡ªè¨‚æ¼¸å±¤æŒ‰éˆ• (ä¸Šå‚³ / å¥—ç”¨ç¯©é¸) */
        .btn-upload {
            background: linear-gradient(90deg, #3DB2FF 0%, #00D1A0 100%);
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(61,178,255,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }
        .btn-upload:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(61,178,255,0.4);
        }
        
        /* 3. è‡ªè¨‚æ¼¸å±¤æŒ‰éˆ• (æ–°å¢æ¢ä»¶ / åŒ¯å‡º) */
        .btn-add {
            background: linear-gradient(90deg, #00C2FF 0%, #00E676 100%);
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0,200,200,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        .btn-add:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,200,200,0.4);
        }
        
        /* 4. è‡ªè¨‚æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• (ç¹¼æ‰¿ .btn-upload) */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            font-size: 100px;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* 5. è‡ªè¨‚è¡¨å–®æ¨£å¼ (ä¸‹æ‹‰é¸å–®/è¼¸å…¥æ¡†) */
        .form-input-style {
            border-radius: 12px !important;
            border: 1px solid #E0E0E0 !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important;
            background-color: white !important;
            color: #111827 !important;
            padding-top: 0.6rem; /* å¢åŠ ä¸€é»å…§è· */
            padding-bottom: 0.6rem;
            transition: all 0.3s ease;
        }
        .form-input-style:focus {
            border-color: #3DB2FF !important;
            box-shadow: 0 0 0 3px rgba(61,178,255,0.2) !important;
            outline: none !important;
        }
        .form-input-style:disabled {
            background-color: #F3F4F6 !important; /* gray-100 */
            color: #9CA3AF !important; /* gray-400 */
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }


        /* 6. è‡ªè¨‚æ»¾å‹•æ¢ (ç¾åŒ–) */
        #results-output::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #results-output::-webkit-scrollbar-track {
            background: #F3F4F6; /* gray-100 */
            border-radius: 10px;
        }
        #results-output::-webkit-scrollbar-thumb {
            background: #CBD5E1; /* gray-300 */
            border-radius: 10px;
        }
        #results-output::-webkit-scrollbar-thumb:hover {
            background: #94A3B8; /* gray-400 */
        }

        /* 7. è¡¨æ ¼æ¨£å¼ */
        table {
            border-spacing: 0;
            min-width: 100%;
        }
        th, td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
            white-space: nowrap;
        }
        th {
            background-color: #E6F4FF; /* äº®è—è‰²èƒŒæ™¯ */
            color: #005A9C; /* æ·±è—è‰²æ–‡å­— */
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #F9FAFB; /* æ·ºç° (gray-50) */
        }
        tr:hover {
            background-color: #E0F2FE; /* äº®è— (blue-100) */
        }

        /* ç¯©é¸æ¢ä»¶çµ„å‹•ç•« */
        .filter-group {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        .filter-group-enter {
            opacity: 0;
            max-height: 0px;
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .filter-group-exit {
            opacity: 0;
            max-height: 0px;
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        /* éš±è—è¼”åŠ© class */
        .hidden-strict {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- (ä¿®æ”¹) ç™»å…¥å®¹å™¨ï¼Œæ”¹ç‚º Google ç™»å…¥ -->
    <div id="login-container" class="container mx-auto p-4 md:p-8 max-w-md mt-20">
        <main class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">æ­¡è¿ä½¿ç”¨</h1>
            <p class="text-center text-gray-600 mb-6">è«‹ä½¿ç”¨ @ppsh.ptc.edu.tw ç¶²åŸŸå¸³è™Ÿç™»å…¥</p>
            <div class="space-y-4">
                <!-- Google ç™»å…¥æŒ‰éˆ• -->
                <button id="google-login-btn" class="btn-upload w-full !rounded-xl !py-3 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C39.756 34.927 44 28.159 44 20c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-2 h-4 text-center"></p>
            </div>
        </main>
    </div>

    <!-- (ä¿®æ”¹) ä¸»è¦æ‡‰ç”¨å®¹å™¨ï¼Œé è¨­éš±è— -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        
        <!-- (ä¿®æ”¹) æ¨™é¡Œï¼ŒåŠ å…¥ relative å’Œç™»å‡ºæŒ‰éˆ• -->
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">å‡å­¸è³‡æ–™ç¯©é¸ç­–ç•¥</h1>
            <p id="user-display" class="text-gray-600 mt-1"></p>
            <button id="logout-btn" class="absolute top-0 right-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-xl transition duration-300">ç™»å‡º</button>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ (æ”¹ç‚ºç™½åº•å¡ç‰‡) -->
        <main class="bg-white shadow-xl rounded-2xl p-6 md:p-8">

            <!-- (ä¿®æ”¹) æª”æ¡ˆä¸Šå‚³å€ï¼ŒåŠ å…¥ ID -->
            <section id="upload-section" class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">1. ä¸Šå‚³è³‡æ–™ (åƒ…é™ç®¡ç†è€…)</h2>
                <!-- æ”¹ç‚ºç™½åº• + æ·¡è—é‚Šæ¡† -->
                <div class="flex flex-col items-center p-6 bg-white border-2 border-dashed border-blue-200 rounded-2xl">
                    <!-- è‡ªè¨‚æŒ‰éˆ• (å¥—ç”¨ .btn-upload) -->
                    <label class="file-input-wrapper btn-upload" for="file-input">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="align-middle">é¸æ“‡ .xlsx æˆ– .csv æª”æ¡ˆ</span>
                        <!-- éš±è—çš„å¯¦éš› input -->
                        <input type="file" id="file-input" accept=".xlsx, .csv" class="hidden">
                    </label>
                    <span id="file-name" class="mt-3 text-sm text-gray-500">æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ</span>
                </div>
            </section>

            <!-- ç¯©é¸å™¨å€åŸŸ (æ”¹ç‚ºæ¼¸å±¤å¡ç‰‡) -->
            <section id="filter-controls" class="mb-6 hidden bg-gradient-to-br from-blue-50 to-green-50 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ” ç¯©é¸è³‡æ–™</h2>
                
                <!-- *** (ä¿®æ”¹) æ›´æ–°çš„æç¤ºå€å¡Š *** -->
                <div class="mb-4 p-3 bg-blue-100 border border-blue-200 text-blue-800 rounded-lg text-sm" role="alert">
                    <strong class="font-semibold">ğŸ’¡ ç¯©é¸é‚è¼¯ï¼š</strong>
                    ç³»çµ±æœƒ<strong>ç”±ä¸Šåˆ°ä¸‹</strong>ä¾åºåŸ·è¡Œç¯©é¸æ¢ä»¶ã€‚ä¾‹å¦‚ï¼šå¸Œæœ›é‚è¼¯ç‚º "æ¢ä»¶1 AND (æ¢ä»¶2 OR æ¢ä»¶3)"ï¼Œè«‹å°‡æ¢ä»¶1ç§»åˆ°æœ€å¾Œè¨­å®šã€‚
                </div>

                <!-- å‹•æ…‹æ¢ä»¶çµ„å®¹å™¨ -->
                <div id="filter-groups-container" class="space-y-4">
                    <!-- æ¢ä»¶çµ„å°‡ç”± JS å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
                
                <!-- ä¸»è¦æ“ä½œæŒ‰éˆ• -->
                <div class="flex flex-wrap gap-4 mt-6">
                    <button id="add-filter-btn" class="btn-add rounded-xl py-2 px-4 font-medium flex items-center">
                        <span class="text-lg mr-2">âœ¨</span>
                        ï¼‹ æ–°å¢æ¢ä»¶
                    </button>
                    <button id="clear-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-xl transition duration-300">
                        æ¸…é™¤å…¨éƒ¨
                    </button>
                    <button id="filter-button" class="btn-upload rounded-xl py-2 px-6 font-bold ml-auto">
                        å¥—ç”¨ç¯©é¸
                    </button>
                </div>
            </section>

            <!-- é¡¯ç¤ºè®€å–åˆ°çš„è³‡æ–™ -->
            <section class="mt-6">
                <!-- æ¨™é¡Œ å’Œ åŒ¯å‡ºæŒ‰éˆ• -->
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-800">ğŸ“Š ç¯©é¸çµæœ:</h2>
                    <button id="export-button" class="hidden btn-add rounded-xl py-2 px-4 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="align-middle">åŒ¯å‡º (XLSX)</span>
                    </button>
                </div>

                <!-- æ¢ä»¶æ¨™ç±¤ (Chips) å®¹å™¨ (æ”¹ç‚ºäº®è—è‰²) -->
                <div id="filter-chips-container" class="flex flex-wrap gap-2 mb-4">
                    <!-- ç¯©é¸æ¢ä»¶æ¨™ç±¤å°‡ç”± JS å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>

                <!-- çµæœè¡¨æ ¼ (æ”¹ç‚ºç™½åº•) -->
                <div id="results-output" class="w-full h-96 bg-white text-gray-800 text-sm p-4 rounded-md overflow-auto border border-gray-200 shadow-inner">
                    è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥...
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        // (*** ä¿®æ”¹ ***) è¼‰å…¥ v9 æ¨¡çµ„åŒ–å‡½å¼ (åŒ…å« Google Auth)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";


        // (*** ä¿®æ”¹ ***) ç™»å…¥ç›¸é—œ DOM å…ƒç´  (ç§»é™¤å¯†ç¢¼ï¼Œæ–°å¢ Google)
        const loginContainerEl = document.getElementById('login-container');
        const appContainerEl = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn'); // (*** æ–°å¢ ***)
        const loginErrorEl = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const uploadSectionEl = document.getElementById('upload-section');
        const userDisplayEl = document.getElementById('user-display'); // (*** æ–°å¢ ***)

        // (æ—¢æœ‰) DOM å…ƒç´ 
        const fileInputEl = document.getElementById('file-input');
        const fileNameEl = document.getElementById('file-name');
        const resultsOutputEl = document.getElementById('results-output');
        const filterControlsEl = document.getElementById('filter-controls');
        const filterButtonEl = document.getElementById('filter-button');
        const exportButtonEl = document.getElementById('export-button');
        const filterGroupsContainerEl = document.getElementById('filter-groups-container');
        const addFilterBtnEl = document.getElementById('add-filter-btn');
        const clearFiltersBtnEl = document.getElementById('clear-filters-btn');
        const filterChipsContainerEl = document.getElementById('filter-chips-container');

        // å…¨åŸŸè®Šæ•¸å„²å­˜è³‡æ–™
        let allHeaders = [];
        let allDataRows = [];
        let availableColumns = []; // å„²å­˜ { name, index }
        let currentExportData = null;
        let activeFilters = []; // å„²å­˜ç•¶å‰å¥—ç”¨çš„ç¯©é¸æ¢ä»¶

        // Firebase å…¨åŸŸè®Šæ•¸
        let app, db, auth;
        let userId = null;
        let schoolDataDocRef = null; // æŒ‡å‘å…¬ç”¨è³‡æ–™çš„
        let unsubscribeData = null; // ç”¨æ–¼å–æ¶ˆç›£è½

        // æ‚¨æä¾›çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDw1JOQi3lgGk-9fQbs2MbW-wJd008kqKM",
            authDomain: "screening-strategy.firebaseapp.com",
            projectId: "screening-strategy",
            storageBucket: "screening-strategy.firebasestorage.app",
            messagingSenderId: "675450449375",
            appId: "1:675450449375:web:521bdb4854092f1c05e86a",
            measurementId: "G-GMLSW66F6F"
        };

        // (ä¿®æ”¹) ç™»å…¥ç‹€æ…‹
        let currentUserRole = null;
        
        /**
         * (ä¿®æ”¹) ç™»å…¥å‡½å¼ (åƒ…è™•ç† UI åˆ‡æ›)
         * @param {string} role 'admin' æˆ– 'user'
         */
        function handleLogin(role, userEmail) {
            currentUserRole = role;

            // åˆ‡æ› UI
            loginContainerEl.classList.add('hidden');
            appContainerEl.classList.remove('hidden');
            loginErrorEl.textContent = '';
            
            if (role === 'admin') {
                uploadSectionEl.classList.remove('hidden');
                resultsOutputEl.innerHTML = 'è«‹ä¸Šå‚³æª”æ¡ˆæˆ–ç­‰å¾…è³‡æ–™åº«è¼‰å…¥...';
                userDisplayEl.textContent = `ç®¡ç†è€… (${userEmail}) å·²ç™»å…¥`;
            } else { // 'user'
                uploadSectionEl.classList.add('hidden');
                resultsOutputEl.innerHTML = 'æ­£åœ¨å¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™...';
                userDisplayEl.textContent = `ä½¿ç”¨è€… (${userEmail}) å·²ç™»å…¥`;
            }
            
            // (ä¿®æ”¹) é–‹å§‹ç›£è½è³‡æ–™ (ç§»è‡³ Auth ç‹€æ…‹è®Šæ›´æ™‚)
            // listenForSchoolData(); // ç”± onAuthStateChanged è§¸ç™¼
        }

        /**
         * (ä¿®æ”¹) ç™»å‡ºå‡½å¼ (åƒ…è™•ç† UI é‡è¨­)
         */
        function handleLogout() {
            currentUserRole = null;

            // åœæ­¢ç›£è½
            if (unsubscribeData) {
                unsubscribeData();
                unsubscribeData = null;
            }

            // åˆ‡æ› UI
            loginContainerEl.classList.remove('hidden');
            appContainerEl.classList.add('hidden');
            userDisplayEl.textContent = ''; // (*** æ–°å¢ ***)

            // é‡è¨­æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
            fileInputEl.value = ''; // æ¸…é™¤æª”æ¡ˆè¼¸å…¥
            fileNameEl.textContent = 'æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ';
            resultsOutputEl.innerHTML = 'è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥...'; // (*** ä¿®æ”¹ ***)
            exportButtonEl.classList.add('hidden');
            currentExportData = null;
            filterControlsEl.classList.add('hidden');
            allHeaders = [];
            allDataRows = [];
            availableColumns = [];
            clearAllFilters(false); // æ¸…é™¤ç¯©é¸å™¨ä½†ä¸é¡¯ç¤ºé è¦½
        }

        /**
         * (*** æ–°å¢ ***) Google ç™»å…¥å‡½å¼
         */
        async function signInWithGoogle() {
            if (!auth) return;

            const provider = new GoogleAuthProvider();
            
            // (*** æ–°å¢ ***) é™åˆ¶ç™»å…¥ç¶²åŸŸ
            provider.setCustomParameters({
                'hd': 'ppsh.ptc.edu.tw'
            });

            try {
                loginErrorEl.textContent = 'æ­£åœ¨é–‹å•Ÿ Google ç™»å…¥è¦–çª—...';
                await signInWithPopup(auth, provider);
                // ç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè‡ªå‹•è§¸ç™¼
                loginErrorEl.textContent = '';
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                
                // (*** æ–°å¢ ***) åµæ¸¬ auth/unauthorized-domain
                if (error.code === 'auth/unauthorized-domain') {
                    loginErrorEl.textContent = 'éŒ¯èª¤ï¼šæ­¤ç¶²åŸŸæœªè¢« Firebase æˆæ¬Šã€‚';
                    alert('ç™»å…¥å¤±æ•—ï¼šæ­¤æ‡‰ç”¨ç¨‹å¼çš„ç¶²åŸŸ (..scf.usercontent.goog) æœªè¢«åŠ å…¥åˆ° Firebase å°ˆæ¡ˆçš„ã€Œæˆæ¬Šç¶²åŸŸã€æ¸…å–®ä¸­ã€‚è«‹è¯ç¹«ç®¡ç†è€…è™•ç†ã€‚');
                }
                else if (error.code === 'auth/popup-closed-by-user') {
                    loginErrorEl.textContent = 'ç™»å…¥è¦–çª—å·²é—œé–‰ã€‚';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    // å¿½ç•¥
                } else if (error.code === 'auth/operation-not-allowed') {
                     loginErrorEl.textContent = 'éŒ¯èª¤ï¼šå°šæœªåœ¨ Firebase å°ˆæ¡ˆä¸­å•Ÿç”¨ Google ç™»å…¥ã€‚';
                }
                else {
                    loginErrorEl.textContent = `ç™»å…¥å¤±æ•—ï¼š${error.message}`;
                }
            }
        }

        // (*** æ–°å¢ ***) Google ç™»å…¥äº‹ä»¶ç›£è½
        googleLoginBtn.addEventListener('click', signInWithGoogle);

        // (*** ä¿®æ”¹ ***) ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ç›£è½
        logoutBtn.addEventListener('click', async () => {
            if (auth) {
                await signOut(auth); // è§¸ç™¼ onAuthStateChanged
            }
        });


        /**
         * (ä¿®æ”¹) åˆå§‹åŒ– Firebase æ‡‰ç”¨å’Œèªè­‰ (ä½¿ç”¨ v9 æ¨¡çµ„åŒ–èªæ³•)
         */
        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // setLogLevel('debug'); // é–‹å•Ÿæ—¥èªŒ

                // ç°¡åŒ–è·¯å¾‘
                schoolDataDocRef = doc(db, 'public_data', 'school_data');


                // (*** ä¿®æ”¹ ***) æ ¸å¿ƒèªè­‰é‚è¼¯
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // ä½¿ç”¨è€…å·²ç™»å…¥
                        userId = user.uid;
                        const userEmail = user.email || '';
                        
                        // (*** æ–°å¢ ***) æª¢æŸ¥ Email ç¶²åŸŸ
                        if (userEmail === 'fuwen@ppsh.ptc.edu.tw') {
                            // ç®¡ç†è€…
                            console.log("ç®¡ç†è€…ç™»å…¥:", userId, userEmail);
                            handleLogin('admin', userEmail);
                            listenForSchoolData(); // ç™»å…¥æˆåŠŸå¾Œé–‹å§‹ç›£è½
                        } 
                        else if (userEmail.endsWith('@ppsh.ptc.edu.tw')) {
                            // ä¸€èˆ¬ä½¿ç”¨è€…
                            console.log("ä¸€èˆ¬ä½¿ç”¨è€…ç™»å…¥:", userId, userEmail);
                            handleLogin('user', userEmail);
                            listenForSchoolData(); // ç™»å…¥æˆåŠŸå¾Œé–‹å§‹ç›£è½
                        } 
                        else {
                            // ç¶²åŸŸä¸ç¬¦
                            console.warn("ç¶²åŸŸä¸ç¬¦ï¼Œå¼·åˆ¶ç™»å‡º:", userEmail);
                            loginErrorEl.textContent = 'éŒ¯èª¤ï¼šåƒ…å…è¨± @ppsh.ptc.edu.tw ç¶²åŸŸç™»å…¥ã€‚';
                            signOut(auth); // å¼·åˆ¶ç™»å‡º
                        }
                        
                    } else {
                        // ä½¿ç”¨è€…å·²ç™»å…¥
                        userId = null;
                        console.log("ä½¿ç”¨è€…å·²ç™»å‡º");
                        handleLogout(); // å‘¼å«ç™»å‡º UI
                    }
                });

            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                resultsOutputEl.innerHTML = `Firebase åˆå§‹åŒ–å¤±æ•—: ${e.message}ã€‚è«‹åˆ·æ–°é é¢ã€‚`;
            }
        }
        
        /**
         * ç›£è½å…¬ç”¨è³‡æ–™åº«ä¸­çš„è³‡æ–™ (ä½¿ç”¨ v9 æ¨¡çµ„åŒ–èªæ³•)
         */
        function listenForSchoolData() {
            if (!schoolDataDocRef) {
                console.error("Database reference is not set.");
                return;
            }

            // é˜²æ­¢é‡è¤‡ç›£è½
            if (unsubscribeData) {
                unsubscribeData();
            }

            resultsOutputEl.textContent = 'æ­£åœ¨å¾è³‡æ–™åº«åŒæ­¥è³‡æ–™...';

            unsubscribeData = onSnapshot(schoolDataDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // è³‡æ–™å­˜åœ¨
                    const data = docSnap.data();
                    try {
                        allHeaders = data.headers || [];
                        allDataRows = JSON.parse(data.rows_json || '[]'); 
                        
                        populateAvailableColumns();
                        filterControlsEl.classList.remove('hidden');
                        clearAllFilters(true); // é¡¯ç¤ºé è¦½
                        
                        fileNameEl.textContent = `å·²å¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™ (æœ€å¾Œæ›´æ–°æ–¼: ${new Date().toLocaleTimeString()})`;
                        console.log("è³‡æ–™åº«è³‡æ–™å·²è¼‰å…¥");

                    } catch (e) {
                        console.error("è§£æè³‡æ–™åº«è³‡æ–™å¤±æ•—:", e);
                        resultsOutputEl.textContent = `è§£æè³‡æ–™åº«è³‡æ–™å¤±æ•—: ${e.message}`;
                    }

                } else {
                    // è³‡æ–™ä¸å­˜åœ¨
                    console.log("è³‡æ–™åº«ä¸­å°šç„¡è³‡æ–™");
                    allHeaders = [];
                    allDataRows = [];
                    filterControlsEl.classList.add('hidden');

                    if (currentUserRole === 'admin') {
                        fileNameEl.textContent = 'è³‡æ–™åº«ç‚ºç©ºï¼Œè«‹ä¸Šå‚³æª”æ¡ˆã€‚';
                        resultsOutputEl.innerHTML = 'è³‡æ–™åº«ç‚ºç©ºã€‚è«‹ä¸Šå‚³æª”æ¡ˆä»¥å»ºç«‹è³‡æ–™ã€‚';
                    } else {
                        fileNameEl.textContent = 'å°šç„¡è³‡æ–™';
                        resultsOutputEl.innerHTML = 'ç›®å‰è³‡æ–™åº«ä¸­æ²’æœ‰è³‡æ–™ã€‚è«‹ç­‰å¾…ç®¡ç†è€…ä¸Šå‚³ã€‚';
                    }
                }
            }, (error) => {
                console.error("ç›£è½è³‡æ–™å¤±æ•—:", error);
                resultsOutputEl.textContent = `ç›£è½è³‡æ–™åº«å¤±æ•—: ${error.message}`;
            });
        }


        /**
         * è™•ç†æª”æ¡ˆä¸Šå‚³äº‹ä»¶ (åƒ…é™ç®¡ç†è€…, ä½¿ç”¨ v9 æ¨¡çµ„åŒ–èªæ³•)
         */
        async function handleFile(event) {
            const file = event.target.files[0];
            if (!file) {
                fileNameEl.textContent = 'æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ';
                return;
            }

            fileNameEl.textContent = `å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}`;
            resultsOutputEl.textContent = 'æ­£åœ¨è®€å–æª”æ¡ˆ...';
            
            if (!schoolDataDocRef) {
                resultsOutputEl.textContent = 'éŒ¯èª¤ï¼šè³‡æ–™åº«å°šæœªé€£æ¥ã€‚';
                return;
            }

            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    if (jsonData.length < 2) {
                        throw new Error("æª”æ¡ˆä¸­æ²’æœ‰è¶³å¤ çš„è³‡æ–™ (è‡³å°‘éœ€è¦æ¨™é ­åˆ—å’Œä¸€ç­†è³‡æ–™)ã€‚");
                    }

                    const tempHeaders = jsonData[0];
                    const tempDataRows = jsonData.slice(1);

                    resultsOutputEl.textContent = 'æª”æ¡ˆè®€å–å®Œç•¢ï¼Œæ­£åœ¨å„²å­˜è‡³è³‡æ–™åº«...';

                    const payload = {
                        headers: tempHeaders,
                        rows_json: JSON.stringify(tempDataRows) // å°‡è³‡æ–™åˆ—å„²å­˜ç‚º JSON å­—ä¸²
                    };

                    await setDoc(schoolDataDocRef, payload);

                    // æˆåŠŸè¨Šæ¯ã€‚
                    // çœŸæ­£çš„è³‡æ–™è¼‰å…¥å°‡ç”± onSnapshot ç›£è½å™¨è‡ªå‹•è§¸ç™¼ã€‚
                    fileNameEl.textContent = 'è³‡æ–™å„²å­˜æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...';
                    
                } catch (error) {
                    console.error("å„²å­˜è‡³è³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    resultsOutputEl.textContent = `å„²å­˜å¤±æ•—ï¼š${error.message}`;
                    fileNameEl.textContent = 'å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦';
                }
            };
            
            reader.onerror = function(e) {
                console.error("FileReader éŒ¯èª¤:", e);
                resultsOutputEl.textContent = 'ç„¡æ³•è®€å–æª”æ¡ˆã€‚';
                fileNameEl.textContent = 'ç„¡æ³•è®€å–æª”æ¡ˆ';
            };
            
            reader.readAsBinaryString(file);
        }

        // --- (ä»¥ä¸‹æ˜¯ç¯©é¸å’Œ UI é‚è¼¯ï¼Œå¤§éƒ¨åˆ†ä¸è®Š) ---

        /**
         * å»ºç«‹å¯ç”¨çš„æ¬„ä½åˆ—è¡¨
         */
        function populateAvailableColumns() {
            availableColumns = allHeaders.map((header, index) => ({
                name: header || `(ç¬¬ ${index + 1} æ¬„)`,
                index: index
            }));
        }

        /**
         * é¡¯ç¤ºå‰ 12 ç­†è³‡æ–™ (ç¬¬ 2-9 æ¬„) ä½œç‚ºé è¦½
         */
        function displayInitialPreview() {
            resultsOutputEl.innerHTML = '';
            exportButtonEl.classList.add('hidden');
            currentExportData = null;

            if (allDataRows.length === 0) {
                resultsOutputEl.textContent = 'æ²’æœ‰è³‡æ–™å¯ä¾›é è¦½ã€‚';
                return;
            }
            if (allHeaders.length < 9) {
                resultsOutputEl.textContent = `éŒ¯èª¤ï¼šæª”æ¡ˆæ¬„ä½ä¸è¶³ 9 æ¬„ï¼Œç„¡æ³•é¡¯ç¤ºé è¦½ã€‚`;
                return;
            }

            const previewHeaders = allHeaders.slice(1, 9);
            const previewRows = allDataRows.slice(0, 12);
            let html = '<table class="w-full text-left border-collapse">';
            html += '<thead><tr>';
            previewHeaders.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead>';
            html += '<tbody>';
            previewRows.forEach(row => {
                html += '<tr>';
                for (let i = 1; i <= 8; i++) {
                    const cellData = (row[i] === null || row[i] === undefined) ? '' : row[i];
                    html += `<td>${cellData}</td>`;
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            resultsOutputEl.innerHTML = html;
        }
        
        /**
         * (æ–°å¢) æ›´æ–°æ‰€æœ‰æ¢ä»¶çµ„çš„æ¨™é¡Œå’Œç§»é™¤æŒ‰éˆ•
         */
        function updateFilterGroupHeaders() {
            const allGroups = filterGroupsContainerEl.querySelectorAll('.filter-group');
            allGroups.forEach((group, index) => {
                const isFirst = (index === 0);
                
                // 1. å°‹æ‰¾æˆ–å»ºç«‹æ¨™é ­å®¹å™¨
                let headerEl = group.querySelector('.filter-group-header');
                if (!headerEl) {
                    headerEl = document.createElement('div');
                    headerEl.className = 'filter-group-header';
                    group.prepend(headerEl); // æ’å…¥åˆ°å¡ç‰‡æœ€é ‚éƒ¨
                }

                // 2. ç”¢ç”Ÿæ¨™é ­ HTML
                let headerHTML = '';
                if (!isFirst) {
                    // æ¢ä»¶ 2+ : åŒ…å«é‚è¼¯
                    const existingLogicSelect = group.querySelector('.filter-logic');
                    const currentLogic = existingLogicSelect ? existingLogicSelect.value : 'AND';

                    headerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <select class="filter-logic w-auto p-2 form-input-style">
                                <option value="AND" ${currentLogic === 'AND' ? 'selected' : ''}>AND (ä¸”)</option>
                                <option value="OR" ${currentLogic === 'OR' ? 'selected' : ''}>OR (æˆ–)</option>
                            </select>
                            <span class="text-lg font-semibold text-gray-700">ğŸ” æ¢ä»¶ ${index + 1}</span>
                        </div>
                    `;
                } else {
                    // æ¢ä»¶ 1 : åªæœ‰æ¨™é¡Œ
                    headerHTML = `<h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ” æ¢ä»¶ ${index + 1}</h3>`;
                }
                headerEl.innerHTML = headerHTML;

                // 3. æ›´æ–°ç§»é™¤æŒ‰éˆ•çš„å¯è¦‹æ€§
                const removeBtn = group.querySelector('.remove-filter-btn');
                if (removeBtn) {
                    if (isFirst && allGroups.length === 1) {
                        removeBtn.classList.add('hidden'); // åªæœ‰ä¸€å¼µå¡ç‰‡ï¼Œéš±è—
                    } else if (isFirst && allGroups.length > 1) {
                         removeBtn.classList.add('hidden'); // æ˜¯ç¬¬ä¸€å¼µå¡ç‰‡(ä¸”ä¸åªä¸€å¼µ)ï¼Œéš±è—
                    } else {
                        removeBtn.classList.remove('hidden'); // ä¸æ˜¯ç¬¬ä¸€å¼µå¡ç‰‡ï¼Œé¡¯ç¤º
                    }
                }
            });

            // å‚™ç”¨ï¼šå¦‚æœåªæœ‰ä¸€å¼µå¡ï¼Œç¢ºä¿å…¶ç§»é™¤æŒ‰éˆ•æ˜¯éš±è—çš„
            if (allGroups.length === 1) {
                 const removeBtn = allGroups[0].querySelector('.remove-filter-btn');
                 if(removeBtn) removeBtn.classList.add('hidden');
            }
        }


        /**
         * (ä¿®æ”¹) æ–°å¢ä¸€å€‹æ¢ä»¶çµ„
         */
        function addFilterGroup(logic = 'AND') {
            const groupWrapper = document.createElement('div');
            groupWrapper.className = 'filter-group bg-white p-4 rounded-xl shadow-md';
            
            // --- (ä¿®æ”¹) æ¨™é ­(Header)å°‡ç”± updateFilterGroupHeaders å‡½å¼è™•ç† ---
            const headerContainer = document.createElement('div');
            headerContainer.className = 'filter-group-header';
            groupWrapper.appendChild(headerContainer); // å…ˆåŠ ä¸€å€‹ç©ºçš„

            // --- HTML çµæ§‹ (ç§»é™¤æ¨™é ­) ---
            const groupHTML = `
                <!-- ç¬¬ä¸€è¡Œï¼šæ¬„ä½ã€é‹ç®—å­ã€æ¯”è¼ƒå°è±¡ã€ç§»é™¤ -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <!-- æ¬„ä½é¸æ“‡ -->
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">æ¬„ä½ (å·¦)</label>
                        <select class="filter-column w-full p-2 form-input-style">
                            <option value="">-- é¸æ“‡æ¬„ä½ --</option>
                            ${availableColumns.map(col => `<option value="${col.index}">${col.name}</option>`).join('')}
                        </select>
                    </div>
                    <!-- é‹ç®—å­ -->
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-600 mb-1">é‹ç®—å­</label>
                        <select class="filter-operator w-full p-2 form-input-style">
                            <option value="contains">åŒ…å«</option>
                            <option value="not_contains">ä¸åŒ…å«</option>
                            <option value="equals">ï¼ (ç­‰æ–¼)</option>
                            <option value"not_equals">â‰  (ä¸ç­‰æ–¼)</option>
                            <option value="gt">ï¼ (å¤§æ–¼)</option>
                            <option value="lt">ï¼œ (å°æ–¼)</option>
                            <option value="gte">â‰¥ (å¤§æ–¼ç­‰æ–¼)</option>
                            <option value="lte">â‰¤ (å°æ–¼ç­‰æ–¼)</option>
                            <option value="between">ä»‹æ–¼</option>
                        </select>
                    </div>
                    <!-- æ¯”è¼ƒå°è±¡ (å›ºå®šå€¼/æ¬„ä½) -->
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">æ¯”è¼ƒå°è±¡ (å³)</label>
                        <select class="filter-target-type w-full p-2 form-input-style transition-colors duration-200">
                            <option value="value">å›ºå®šå€¼</option>
                            <option value="column">æ¬„ä½</option>
                        </select>
                    </div>
                    <!-- ç§»é™¤æŒ‰éˆ• (ç§»é™¤ isFirst åˆ¤æ–·) -->
                    <div class="md:col-span-1 flex items-end">
                        <button class="remove-filter-btn text-gray-400 hover:text-red-500 transition duration-300 p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- ç¬¬äºŒè¡Œï¼šå€¼è¼¸å…¥å€åŸŸ -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-4">
                    <!-- å€¼ 1 (å›ºå®šå€¼) -->
                    <div class="filter-value-1-wrapper md:col-span-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">å€¼</label>
                        <input type="text" class="filter-value-1 w-full p-2 form-input-style" placeholder="è¼¸å…¥å€¼...">
                    </div>
                    <!-- å€¼ 2 (ä»‹æ–¼) -->
                    <div class="filter-value-2-wrapper md:col-span-4 hidden-strict">
                        <label class="block text-sm font-medium text-gray-600 mb-1">è‡³</label>
                        <input type="text" class="filter-value-2 w-full p-2 form-input-style" placeholder="è¼¸å…¥å€¼...">
                    </div>
                    <!-- å€¼ (æ¬„ä½) -->
                    <div class="filter-value-column-wrapper md:col-span-4 hidden-strict">
                        <label class="block text-sm font-medium text-gray-600 mb-1">é¸æ“‡æ¬„ä½</label>
                        <select class="filter-value-column w-full p-2 form-input-style">
                            <option value="">-- é¸æ“‡æ¬„ä½ --</option>
                            ${availableColumns.map(col => `<option value="${col.index}">${col.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            
            // (ä¿®æ”¹) å»ºç«‹ä¸€å€‹å®¹å™¨ä¾†æ”¾ form
            const formContainer = document.createElement('div');
            formContainer.innerHTML = groupHTML;
            groupWrapper.appendChild(formContainer);

            // å‹•ç•«ï¼šæ·¡å…¥
            groupWrapper.classList.add('filter-group-enter');
            filterGroupsContainerEl.appendChild(groupWrapper);
            // è§¸ç™¼ CSS å‹•ç•«
            setTimeout(() => {
                groupWrapper.classList.remove('filter-group-enter');
            }, 10); // çŸ­æš«å»¶é²ä»¥è§¸ç™¼ transition

            // ç¶å®šæ–°æŒ‰éˆ•çš„äº‹ä»¶
            groupWrapper.querySelector('.remove-filter-btn').addEventListener('click', (e) => {
                removeFilterGroup(e.currentTarget);
            });
            // ç¶å®šé‹ç®—å­ change äº‹ä»¶
            const operatorSelect = groupWrapper.querySelector('.filter-operator');
            operatorSelect.addEventListener('change', (e) => {
                updateOperatorInputs(e.currentTarget);
            });
            // ç¶å®šæ¯”è¼ƒå°è±¡ change äº‹ä»¶
            const targetTypeSelect = groupWrapper.querySelector('.filter-target-type');
            targetTypeSelect.addEventListener('change', (e) => {
                updateTargetTypeInputs(e.currentTarget);
            });

            // (ä¿®æ”¹) è§¸ç™¼ä¸€æ¬¡ï¼Œç¢ºä¿åˆå§‹ UI æ­£ç¢º
            updateOperatorInputs(operatorSelect);
            
            // (ä¿®æ”¹) æœ€å¾Œï¼Œæ›´æ–°æ‰€æœ‰æ¨™é ­
            updateFilterGroupHeaders();
        }

        /**
         * (ä¿®æ”¹) ç§»é™¤ä¸€å€‹æ¢ä»¶çµ„
         */
        function removeFilterGroup(removeButton) {
            const groupWrapper = removeButton.closest('.filter-group');
            // å‹•ç•«ï¼šæ·¡å‡º
            groupWrapper.classList.add('filter-group-exit');
            groupWrapper.addEventListener('transitionend', () => {
                groupWrapper.remove();
                // (ä¿®æ”¹) ç§»é™¤å¾Œï¼Œæ›´æ–°æ‰€æœ‰æ¨™é ­
                updateFilterGroupHeaders();
            }, { once: true });
        }

        /**
         * (æ›´æ–°) æ ¹æ“šé‹ç®—å­æ›´æ–° UI
         */
        function updateOperatorInputs(operatorSelect) {
            const groupWrapper = operatorSelect.closest('.filter-group');
            const value1Wrapper = groupWrapper.querySelector('.filter-value-1-wrapper');
            const value2Wrapper = groupWrapper.querySelector('.filter-value-2-wrapper');
            const targetTypeSelect = groupWrapper.querySelector('.filter-target-type');
            
            const op = operatorSelect.value;

            if (op === 'contains' || op === 'not_contains' || op === 'between') {
                // åŒ…å«/ä»‹æ–¼ï¼šå¼·åˆ¶å›ºå®šå€¼, ç¦ç”¨ "æ¯”è¼ƒå°è±¡" ä¸‹æ‹‰é¸å–®
                targetTypeSelect.disabled = true;
                targetTypeSelect.value = 'value'; // å¼·åˆ¶è¨­ç‚º value
            } else {
                // ç­‰æ–¼, ä¸ç­‰æ–¼, å¤§æ–¼, å°æ–¼...ï¼šå…è¨±åˆ‡æ›
                targetTypeSelect.disabled = false;
            }

            // æ ¹æ“š "ä»‹æ–¼" é¡¯ç¤º/éš±è— å€¼2
            if (op === 'between') {
                value2Wrapper.classList.remove('hidden-strict');
            } else {
                value2Wrapper.classList.add('hidden-strict');
            }

            // ç¸½æ˜¯è§¸ç™¼ target type select çš„ change äº‹ä»¶
            updateTargetTypeInputs(targetTypeSelect);
        }

        /**
         * (æ›´æ–°) æ ¹æ“šæ¯”è¼ƒå°è±¡æ›´æ–° UI
         */
        function updateTargetTypeInputs(targetTypeSelect) {
            const groupWrapper = targetTypeSelect.closest('.filter-group');
            const value1Wrapper = groupWrapper.querySelector('.filter-value-1-wrapper');
            const valueColumnWrapper = groupWrapper.querySelector('.filter-value-column-wrapper');
            const value2Wrapper = groupWrapper.querySelector('.filter-value-2-wrapper');
            const operatorSelect = groupWrapper.querySelector('.filter-operator');

            if (targetTypeSelect.value === 'column') {
                value1Wrapper.classList.add('hidden-strict');
                valueColumnWrapper.classList.remove('hidden-strict');
                value2Wrapper.classList.add('hidden-strict'); 
            } else { // 'value'
                value1Wrapper.classList.remove('hidden-strict');
                valueColumnWrapper.classList.add('hidden-strict');
                // åƒ…ç•¶é‹ç®—å­æ˜¯ 'between' æ™‚æ‰é¡¯ç¤º å€¼2
                if (operatorSelect.value === 'between') {
                     value2Wrapper.classList.remove('hidden-strict');
                } else {
                     value2Wrapper.classList.add('hidden-strict');
                }
            }
        }
        
        /**
         * (ä¿®æ”¹) æ¸…é™¤æ‰€æœ‰æ¢ä»¶çµ„
         */
        function clearAllFilters(showPreview = true) {
            filterGroupsContainerEl.innerHTML = '';
            // (*** ä¿®æ”¹ ***) åªæœ‰åœ¨æœ‰æ¬„ä½å¯é¸æ™‚æ‰æ–°å¢
            if(availableColumns.length > 0) {
                 addFilterGroup(); // æ–°å¢ç¬¬ä¸€å€‹é è¨­ç¾¤çµ„
            }
            
            if (showPreview && allDataRows.length > 0) {
                displayInitialPreview(); // é¡¯ç¤ºé è¦½
            } else if (currentUserRole === 'admin' && allDataRows.length === 0) {
                resultsOutputEl.innerHTML = 'è³‡æ–™åº«ç‚ºç©ºæˆ–è³‡æ–™å·²æ¸…é™¤ã€‚è«‹ä¸Šå‚³æª”æ¡ˆã€‚';
            } else if (currentUserRole === 'user' && allDataRows.length === 0) {
                 resultsOutputEl.innerHTML = 'ç›®å‰è³‡æ–™åº«ä¸­æ²’æœ‰è³‡æ–™ã€‚è«‹ç­‰å¾…ç®¡ç†è€…ä¸Šå‚³ã€‚';
            } else if (!currentUserRole) {
                resultsOutputEl.innerHTML = 'è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥...'; // ç™»å‡ºæ™‚
            }

            exportButtonEl.classList.add('hidden');
            currentExportData = null;
            updateFilterChips(); // æ¸…é™¤æ¨™ç±¤
        }

        /**
         * (é‡å¯«) æª¢æŸ¥å–®ä¸€æ¢ä»¶æ˜¯å¦æ»¿è¶³
         */
        function checkCondition(row, filter) {
            const { colIndex, operator, targetType, val1, val2, valueColIndex } = filter;

            if (colIndex === "") return true; // æœªé¸æ“‡å·¦å´æ¬„ä½

            // å–å¾—å·¦å´å€¼
            const leftVal = (row[colIndex] === null || row[colIndex] === undefined) ? '' : row[colIndex];

            try {
                // --- æƒ…æ³ 1ï¼šæ¯”è¼ƒå°è±¡æ˜¯ã€Œå›ºå®šå€¼ã€---
                if (targetType === 'value') {
                    if (val1 === "") return true; // æœªè¼¸å…¥å€¼

                    const leftValStr = String(leftVal).toLowerCase();
                    const val1Str = String(val1).toLowerCase();
                    const leftValNum = parseFloat(leftVal);
                    const val1Num = parseFloat(val1);
                    const val2Num = parseFloat(val2);
                    const isNumeric = !isNaN(leftValNum) && !isNaN(val1Num);

                    switch (operator) {
                        case 'contains':
                            return leftValStr.includes(val1Str);
                        case 'not_contains':
                            return !leftValStr.includes(val1Str);
                        case 'equals':
                            return isNumeric ? leftValNum === val1Num : leftValStr === val1Str;
                        case 'not_equals':
                            return isNumeric ? leftValNum !== val1Num : leftValStr !== val1Str;
                        case 'gt':
                            return isNumeric ? leftValNum > val1Num : leftValStr > val1Str;
                        case 'lt':
                            return isNumeric ? leftValNum < val1Num : leftValStr < val1Num;
                        case 'gte':
                            return isNumeric ? leftValNum >= val1Num : leftValStr >= val1Str;
                        case 'lte':
                            return isNumeric ? leftValNum <= val1Num : leftValStr <= val1Str;
                        case 'between':
                            if (val2 === "") return true; // ç¬¬äºŒå€‹å€¼ç‚ºç©º
                            if (isNumeric && !isNaN(val2Num)) {
                                return leftValNum >= Math.min(val1Num, val2Num) && leftValNum <= Math.max(val1Num, val2Num);
                            }
                            // å­—ä¸²ä»‹æ–¼
                            const [minStr, maxStr] = [val1Str, String(val2).toLowerCase()].sort();
                            return leftValStr >= minStr && leftValStr <= maxStr;
                        default:
                            return true;
                    }
                }
                // --- æƒ…æ³ 2ï¼šæ¯”è¼ƒå°è±¡æ˜¯ã€Œæ¬„ä½ã€---
                else if (targetType === 'column') {
                    if (valueColIndex === "") return true; // æœªé¸æ“‡å³å´æ¬„ä½

                    // å–å¾—å³å´å€¼
                    const rightVal = (row[valueColIndex] === null || row[valueColIndex] === undefined) ? '' : row[valueColIndex];

                    const leftValStr = String(leftVal).toLowerCase();
                    const rightValStr = String(rightVal).toLowerCase();
                    const leftValNum = parseFloat(leftVal);
                    const rightValNum = parseFloat(rightVal);
                    const isNumeric = !isNaN(leftValNum) && !isNaN(rightValNum);

                    switch (operator) {
                        case 'equals':
                            return isNumeric ? leftValNum === rightValNum : leftValStr === rightValStr;
                        case 'not_equals':
                            return isNumeric ? leftValNum !== rightValNum : leftValStr !== rightValStr;
                        case 'gt':
                            return isNumeric ? leftValNum > rightValNum : leftValStr > rightValStr;
                        case 'lt':
                            return isNumeric ? leftValNum < rightValNum : leftValStr < rightValStr;
                        case 'gte':
                            return isNumeric ? leftValNum >= rightValNum : leftValStr >= rightValStr;
                        case 'lte':
                            return isNumeric ? leftValNum <= rightValNum : leftValStr <= rightValStr;
                        default:
                            return true;
                    }
                }
            } catch (e) {
                console.warn("Check condition error:", e);
                return true; // å‡ºéŒ¯æ™‚ï¼Œæ”¾è¡Œ
            }
            return true; // é è¨­æ”¾è¡Œ
        }


        /**
         * (é‡å¯«) å¥—ç”¨ç¯©é¸å™¨
         */
        function applyFilter() {
            // 1. å¾ DOM è®€å–ä¸¦å»ºç«‹ç¯©é¸å™¨ç‹€æ…‹
            activeFilters = [];
            const groupElements = filterGroupsContainerEl.querySelectorAll('.filter-group');
            
            groupElements.forEach((group, index) => {
                const colEl = group.querySelector('.filter-column');
                const opEl = group.querySelector('.filter-operator');
                const targetTypeEl = group.querySelector('.filter-target-type');
                const val1El = group.querySelector('.filter-value-1');
                const val2El = group.querySelector('.filter-value-2');
                const valColEl = group.querySelector('.filter-value-column');
                const logicEl = group.querySelector('.filter-logic');
                
                // (*** æ–°å¢ ***) æª¢æŸ¥ colEl æ˜¯å¦å­˜åœ¨
                if (!colEl) return; 

                const targetType = targetTypeEl.value;
                let isValid = false;
                

                if (targetType === 'value') {
                    // (ä¿®æ­£) ä¹Ÿè¦æª¢æŸ¥ 'ä»‹æ–¼' çš„ val2
                    if (opEl.value === 'between') {
                        isValid = colEl.value && val1El.value && val2El.value;
                    } else {
                        isValid = colEl.value && val1El.value; // å¿…é ˆæœ‰æ¬„ä½å’Œå€¼1
                    }
                } else { // targetType === 'column'
                    isValid = colEl.value && valColEl.value; // å¿…é ˆæœ‰æ¬„ä½å’Œå€¼æ¬„ä½
                }

                if (isValid) {
                    activeFilters.push({
                        id: `filter-${Date.now()}-${index}`, // å”¯ä¸€ ID
                        colIndex: colEl.value,
                        colName: colEl.options[colEl.selectedIndex].text,
                        operator: opEl.value,
                        operatorName: opEl.options[opEl.selectedIndex].text,
                        targetType: targetType,
                        val1: val1El.value,
                        val2: val2El ? val2El.value : '',
                        valueColIndex: valColEl.value,
                        valueColName: valColEl.value ? valColEl.options[valColEl.selectedIndex].text : '',
                        logic: (index === 0) ? 'START' : (logicEl ? logicEl.value : 'AND')
                    });
                }
            });

            // 2. æ›´æ–°ç¯©é¸æ¢ä»¶æ¨™ç±¤
            updateFilterChips();

            // 3. åŸ·è¡Œç¯©é¸
            let filteredRows;
            if (activeFilters.length === 0) {
                // å¦‚æœæ²’æœ‰'æœ‰æ•ˆ'ç¯©é¸ï¼Œä½†ä½¿ç”¨è€…å¯èƒ½æœ‰é»æ“ŠæŒ‰éˆ•ï¼Œé¡¯ç¤ºå…¨éƒ¨
                // (æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦'è©¦åœ–'ç¯©é¸)
                const hasInput = Array.from(groupElements).some(g => {
                    const colEl = g.querySelector('.filter-column');
                    const val1El = g.querySelector('.filter-value-1');
                    const valColEl = g.querySelector('.filter-value-column');
                    // (*** æ–°å¢ ***) æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                    return (colEl && colEl.value) || (val1El && val1El.value) || (valColEl && valColEl.value);
                });
                
                if (hasInput) {
                    // ä½¿ç”¨è€…æœ‰è¼¸å…¥ï¼Œä½†æ¢ä»¶ä¸å®Œæ•´
                    filteredRows = []; // é¡¯ç¤º'æ‰¾ä¸åˆ°'
                } else {
                    // ä½¿ç”¨è€…æœªè¼¸å…¥ä»»ä½•æ±è¥¿ï¼Œé¡¯ç¤ºå…¨éƒ¨
                    filteredRows = allDataRows;
                }

            } else {
                filteredRows = allDataRows.filter(row => {
                    if (!row) return false;

                    let finalResult = null; // æœ€çµ‚çµæœ

                    for (const filter of activeFilters) {
                        const groupResult = checkCondition(row, filter);

                        if (finalResult === null) {
                            finalResult = groupResult; // ç¬¬ä¸€å€‹æ¢ä»¶
                        } else {
                            if (filter.logic === 'AND') {
                                finalResult = finalResult && groupResult;
                            } else { // OR
                                finalResult = finalResult || groupResult;
                            }
                        }
                    }
                    return finalResult;
                });
            }

            // 4. é¡¯ç¤ºæ ¼å¼åŒ–å¾Œçš„çµæœ
            displayResults(filteredRows);
        }

        /**
         * (é‡å¯«) é¡¯ç¤ºç¯©é¸å¾Œçš„çµæœ (æ ¼å¼åŒ–è¡¨æ ¼)
         */
        function displayResults(rows, message = null) {
            resultsOutputEl.innerHTML = ''; // æ¸…ç©ºçµæœ
            exportButtonEl.classList.add('hidden');
            currentExportData = null;

            if (message) {
                resultsOutputEl.textContent = message;
                return;
            }

            // (*** æ–°å¢ ***) å¦‚æœæ²’æœ‰ headersï¼Œä¸åŸ·è¡Œ
            if(allHeaders.length === 0) {
                // é€™æ˜¯ handleLogout æˆ– åˆå§‹ç‹€æ…‹ï¼Œä¸éœ€è¦é¡¯ç¤ºéŒ¯èª¤
                return;
            }

            const colNames = ["å­¸æ ¡", "æ ¡ç³»åç¨±", "112åˆ†ç™¼çµæœ", "113åˆ†ç™¼çµæœ"];
            const colIndices = [];
            const missingCols = [];
            
            colNames.forEach(name => {
                const trimmedName = name.trim();
                const index = allHeaders.findIndex(header => 
                    (header === null || header === undefined) ? false : header.trim() === trimmedName
                );
                if (index !== -1) {
                    colIndices.push(index);
                } else {
                    missingCols.push(name);
                }
            });

            if (missingCols.length > 0) {
                resultsOutputEl.textContent = `éŒ¯èª¤ï¼šæª”æ¡ˆä¸­ç¼ºå°‘ä»¥ä¸‹å¿…è¦æ¬„ä½ï¼š${missingCols.join('ã€')}`;
                return;
            }

            if (rows.length === 0) {
                // (ä¿®æ”¹) å€åˆ†'æ‰¾ä¸åˆ°'å’Œ'æœªç¯©é¸'
                if(activeFilters.length > 0) {
                    resultsOutputEl.textContent = 'æ‰¾ä¸åˆ°ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™ã€‚';
                } else {
                    // å¦‚æœæ²’æœ‰ activeFilters (ä¾‹å¦‚å‰›æ¸…é™¤)ï¼Œä½† rows æ˜¯ 0 (ä¾‹å¦‚æª”æ¡ˆç‚ºç©º)
                    resultsOutputEl.textContent = 'è³‡æ–™ç‚ºç©ºæˆ–æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚';
                }
                return;
            }

            // --- æº–å‚™åŒ¯å‡ºè³‡æ–™ (ä½¿ç”¨æ‰€æœ‰æ¬„ä½) ---
            currentExportData = [allHeaders, ...rows];
            // --- åŒ¯å‡ºè³‡æ–™æº–å‚™å®Œç•¢ ---

            // å»ºç«‹ HTML è¡¨æ ¼ (åªé¡¯ç¤º 4 æ¬„)
            let html = '<table class="w-full text-left border-collapse">';
            html += '<thead><tr>';
            colNames.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead>';
            html += '<tbody>';
            rows.forEach(row => {
                if (!row) return;
                html += '<tr>';
                colIndices.forEach(idx => {
                    const cellData = (row[idx] === null || row[idx] === undefined) ? '' : row[idx];
                    html += `<td>${cellData}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            resultsOutputEl.innerHTML = html;
            exportButtonEl.classList.remove('hidden');
        }

        /**
         * (æ›´æ–°) æ›´æ–°ç¯©é¸æ¢ä»¶æ¨™ç±¤ (Chips)
         */
        function updateFilterChips() {
            filterChipsContainerEl.innerHTML = '';
            if (activeFilters.length === 0) {
                filterChipsContainerEl.classList.add('hidden');
                return;
            }

            filterChipsContainerEl.classList.remove('hidden');
            
            activeFilters.forEach((filter, index) => {
                let text = '';
                if (filter.targetType === 'column') {
                    text = `<strong>${filter.colName}</strong> ${filter.operatorName} <strong>${filter.valueColName}</strong>`;
                } else { // 'value'
                    text = `<strong>${filter.colName}</strong> ${filter.operatorName} "<strong>${filter.val1}</strong>"`;
                    if (filter.operator === 'between' && filter.val2) {
                        text += ` å’Œ "<strong>${filter.val2}</strong>"`;
                    }
                }


                if (index > 0) {
                    const logicChip = document.createElement('span');
                    logicChip.className = "text-sm font-semibold text-blue-600 px-2 py-1";
                    logicChip.textContent = filter.logic;
                    filterChipsContainerEl.appendChild(logicChip);
                }
                
                // (ä¿®æ”¹) æ”¹ç‚ºäº®è—è‰²
                const chip = document.createElement('div');
                chip.className = "bg-blue-500 text-white text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2";
                chip.innerHTML = `
                    <span>${text}</span>
                    <button data-filter-id="${filter.id}" class="remove-chip-btn text-blue-100 hover:text-white font-bold">&times;</button>
                `;
                filterChipsContainerEl.appendChild(chip);
            });

            // ç¶å®šæ‰€æœ‰ chip ç§»é™¤æŒ‰éˆ•çš„äº‹ä»¶
            filterChipsContainerEl.querySelectorAll('.remove-chip-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    removeFilterChip(e.currentTarget.dataset.filterId);
                });
            });
        }

        /**
         * (æ–°å¢) æ ¹æ“š ID ç§»é™¤ä¸€å€‹ç¯©é¸æ¢ä»¶ (å¾ Chip è§¸ç™¼)
         */
        function removeFilterChip(filterId) {
            // å¾ DOM ä¸­æ‰¾åˆ°å°æ‡‰çš„ group ä¸¦ç§»é™¤
            const filterIndex = activeFilters.findIndex(f => f.id === filterId);
            if (filterIndex === -1) return;

            const groupElements = filterGroupsContainerEl.querySelectorAll('.filter-group');
            if (groupElements[filterIndex]) {
                // (ä¿®æ”¹) ç›´æ¥è§¸ç™¼ç§»é™¤æŒ‰éˆ•é»æ“Šï¼Œè®“ removeFilterGroup çµ±ä¸€è™•ç†
                const removeBtn = groupElements[filterIndex].querySelector('.remove-filter-btn');
                if (removeBtn) {
                    removeFilterGroup(removeBtn);
                }

                setTimeout(() => {
                    applyFilter();
                }, 350); // ç­‰å¾…å‹•ç•«æ™‚é–“
            }
        }


        /**
         * åŒ¯å‡ºçµæœ (XLSX)
         */
        function exportResults() {
            if (!currentExportData || currentExportData.length === 0) {
                console.warn("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºã€‚");
                return;
            }
            const ws = XLSX.utils.aoa_to_sheet(currentExportData);
            
            // (é¸ç”¨) è¨­ç½®æ¬„å¯¬
            try {
                const colsToProcess = Math.min(currentExportData[0].length, 20);
                const colWidths = [];
                for(let i = 0; i < colsToProcess; i++) {
                    let maxLen = (currentExportData[0][i] || '').length;
                    for (let j = 1; j < Math.min(currentExportData.length, 101); j++) {
                        const len = (currentExportData[j][i] || '').toString().length;
                        if (len > maxLen) maxLen = len;
                    }
                    const chineseChars = (currentExportData[0][i].match(/[\u4e00-\u9fa5]/g) || []).length;
                    let adjustedMaxLen = maxLen + chineseChars;
                    adjustedMaxLen = Math.max(adjustedMaxLen, 10);
                    adjustedMaxLen = Math.min(adjustedMaxLen, 50);
                    colWidths.push({ wch: adjustedMaxLen });
                }
                ws['!cols'] = colWidths;
            } catch (e) {
                console.warn("è¨ˆç®—æ¬„å¯¬æ™‚ç™¼ç”ŸéŒ¯èª¤", e);
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç¯©é¸çµæœ");
            try {
                XLSX.writeFile(wb, "å‡å­¸è³‡æ–™_ç¯©é¸çµæœ.xlsx");
            } catch (e) {
                console.error("åŒ¯å‡ºæª”æ¡ˆå¤±æ•—:", e);
                alert("åŒ¯å‡ºæª”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤ã€‚");
            }
        }

        // ç¶å®šæª”æ¡ˆä¸Šå‚³äº‹ä»¶
        fileInputEl.addEventListener('change', handleFile);

        // å¹«æŒ‰éˆ•ç¶å®šäº‹ä»¶
        filterButtonEl.addEventListener('click', applyFilter);
        exportButtonEl.addEventListener('click', exportResults);
        // --- ç¶å®šæ–°æŒ‰éˆ• ---
        addFilterBtnEl.addEventListener('click', () => addFilterGroup());
        clearFiltersBtnEl.addEventListener('click', () => clearAllFilters(true));

        // (*** æ–°å¢ ***) å•Ÿå‹• Firebase åˆå§‹åŒ–
        initializeAppAndAuth();

    </script>

</body>
</html>

