<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡å­¸è³‡æ–™ç¯©é¸ç­–ç•¥</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ SheetJS (xlsx) å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- (*** ä¿®æ”¹ ***) æ›´æ–° Firebase SDK (åŒ…å« Google Auth) -->
    <!-- (*** ä¿®æ­£ ***) ä¿®æ­£ type="module" æ‹¼å¯«éŒ¯èª¤ -->
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js"></script>

    <!-- 
      è¼‰å…¥å­—é«”ï¼š
      1. Poppins (åœ“è§’æ„Ÿ, ç”¨æ–¼æ¨™é¡Œå’ŒæŒ‰éˆ•)
      2. Noto Sans TC (ç¹é«”ä¸­æ–‡å‚™æ´)
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ğŸ¨ é’æ˜¥ç§‘æŠ€æ„Ÿ UI é¢¨æ ¼ ğŸ¨ --- */

        /* 1. æ•´é«”å­—é«”è¨­å®š */
        body {
            /* å„ªå…ˆä½¿ç”¨ Poppinsï¼Œå‚™æ´ä½¿ç”¨ Noto Sans TC */
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: #F7F9FB; /* æ·ºç°èƒŒæ™¯ */
            color: #1F2937; /* é è¨­æ·±è‰²æ–‡å­— */
        }
        h1, h2, h3, button, .font-heading {
             font-family: 'Poppins', 'Noto Sans TC', sans-serif;
        }

        /* 2. è‡ªè¨‚æ¼¸å±¤æŒ‰éˆ• (ä¸Šå‚³ / å¥—ç”¨ç¯©é¸) */
        .btn-upload {
            background: linear-gradient(90deg, #3DB2FF 0%, #00D1A0 100%);
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(61,178,255,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }
        .btn-upload:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(61,178,255,0.4);
        }
        
        /* 3. è‡ªè¨‚æ¼¸å±¤æŒ‰éˆ• (æ–°å¢æ¢ä»¶ / åŒ¯å‡º) */
        .btn-add {
            background: linear-gradient(90deg, #00C2FF 0%, #00E676 100%);
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0,200,200,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        .btn-add:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,200,200,0.4);
        }
        
        /* 4. è‡ªè¨‚æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• (ç¹¼æ‰¿ .btn-upload) */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            font-size: 100px;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* 5. è‡ªè¨‚è¡¨å–®æ¨£å¼ (ä¸‹æ‹‰é¸å–®/è¼¸å…¥æ¡†) */
        .form-input-style {
            border-radius: 12px !important;
            border: 1px solid #E0E0E0 !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important;
            background-color: white !important;
            color: #111827 !important;
            padding-top: 0.6rem; /* å¢åŠ ä¸€é»å…§è· */
            padding-bottom: 0.6rem;
            transition: all 0.3s ease;
        }
        .form-input-style:focus {
            border-color: #3DB2FF !important;
            box-shadow: 0 0 0 3px rgba(61,178,255,0.2) !important;
            outline: none !important;
        }
        .form-input-style:disabled {
            background-color: #F3F4F6 !important; /* gray-100 */
            color: #9CA3AF !important; /* gray-400 */
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }


        /* 6. è‡ªè¨‚æ»¾å‹•æ¢ (ç¾åŒ–) */
        #results-output::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #results-output::-webkit-scrollbar-track {
            background: #F3F4F6; /* gray-100 */
            border-radius: 10px;
        }
        #results-output::-webkit-scrollbar-thumb {
            background: #CBD5E1; /* gray-300 */
            border-radius: 10px;
        }
        #results-output::-webkit-scrollbar-thumb:hover {
            background: #94A3B8; /* gray-400 */
        }

        /* 7. è¡¨æ ¼æ¨£å¼ */
        table {
            border-spacing: 0;
            min-width: 100%;
        }
        th, td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
            white-space: nowrap;
        }
        th {
            background-color: #E6F4FF; /* äº®è—è‰²èƒŒæ™¯ */
            color: #005A9C; /* æ·±è—è‰²æ–‡å­— */
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #F9FAFB; /* æ·ºç° (gray-50) */
        }
        tr:hover {
            background-color: #E0F2FE; /* äº®è— (blue-100) */
        }

        /* ç¯©é¸æ¢ä»¶çµ„å‹•ç•« */
        .filter-group {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        .filter-group-enter {
            opacity: 0;
            max-height: 0px;
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .filter-group-exit {
            opacity: 0;
            max-height: 0px;
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        /* éš±è—è¼”åŠ© class */
        .hidden-strict {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- (ä¿®æ”¹) ç™»å…¥å®¹å™¨ï¼Œæ”¹ç‚º Google ç™»å…¥ -->
    <div id="login-container" class="container mx-auto p-4 md:p-8 max-w-md mt-20">
        <main class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">æ­¡è¿ä½¿ç”¨</h1>
            <p class="text-center text-gray-600 mb-6">è«‹ä½¿ç”¨ @ppsh.ptc.edu.tw ç¶²åŸŸå¸³è™Ÿç™»å…¥</p>
            <div class="space-y-4">
                <!-- Google ç™»å…¥æŒ‰éˆ• -->
                <button id="google-login-btn" class="btn-upload w-full !rounded-xl !py-3 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C39.756 34.927 44 28.159 44 20c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-2 h-4 text-center"></p>
            </div>
        </main>
    </div>

    <!-- (ä¿®æ”¹) ä¸»è¦æ‡‰ç”¨å®¹å™¨ï¼Œé è¨­éš±è— -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        
        <!-- (ä¿®æ”¹) æ¨™é¡Œï¼ŒåŠ å…¥ relative å’Œç™»å‡ºæŒ‰éˆ• -->
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">å‡å­¸è³‡æ–™ç¯©é¸ç­–ç•¥</h1>
            <p id="user-display" class="text-gray-600 mt-1"></p>
            <button id="logout-btn" class="absolute top-0 right-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-xl transition duration-300">ç™»å‡º</button>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ (æ”¹ç‚ºç™½åº•å¡ç‰‡) -->
        <main class="bg-white shadow-xl rounded-2xl p-6 md:p-8">

            <!-- (ä¿®æ”¹) æª”æ¡ˆä¸Šå‚³å€ï¼ŒåŠ å…¥ ID -->
            <section id="upload-section" class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">1. ä¸Šå‚³è³‡æ–™ (åƒ…é™ç®¡ç†è€…)</h2>
                <!-- æ”¹ç‚ºç™½åº• + æ·¡è—é‚Šæ¡† -->
                <div class="flex flex-col items-center p-6 bg-white border-2 border-dashed border-blue-200 rounded-2xl">
                    <!-- è‡ªè¨‚æŒ‰éˆ• (å¥—ç”¨ .btn-upload) -->
                    <label class="file-input-wrapper btn-upload" for="file-input">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="align-middle">é¸æ“‡ .xlsx æˆ– .csv æª”æ¡ˆ</span>
                        <!-- éš±è—çš„å¯¦éš› input -->
                        <input type="file" id="file-input" accept=".xlsx, .csv" class="hidden">
                    </label>
                    <span id="file-name" class="mt-3 text-sm text-gray-500">æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ</span>
                </div>
            </section>

            <!-- ç¯©é¸å™¨å€åŸŸ (æ”¹ç‚ºæ¼¸å±¤å¡ç‰‡) -->
            <section id="filter-controls" class="mb-6 hidden bg-gradient-to-br from-blue-50 to-green-50 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ” ç¯©é¸è³‡æ–™</h2>
                
                <!-- *** (ä¿®æ”¹) æ›´æ–°çš„æç¤ºå€å¡Š *** -->
                <div class="mb-4 p-3 bg-blue-100 border border-blue-200 text-blue-800 rounded-lg text-sm" role="alert">
                    <strong class="font-semibold">ğŸ’¡ ç¯©é¸é‚è¼¯ï¼š</strong>
                    ç³»çµ±æœƒ<strong>ç”±ä¸Šåˆ°ä¸‹</strong>ä¾åºåŸ·è¡Œç¯©é¸æ¢ä»¶ã€‚ä¾‹å¦‚ï¼šå¸Œæœ›é‚è¼¯ç‚º "æ¢ä»¶1 AND (æ¢ä»¶2 OR æ¢ä»¶3)"ï¼Œè«‹å°‡æ¢ä»¶1ç§»åˆ°æœ€å¾Œè¨­å®šã€‚
                </div>

                <!-- å‹•æ…‹æ¢ä»¶çµ„å®¹å™¨ -->
                <div id="filter-groups-container" class="space-y-4">
                    <!-- æ¢ä»¶çµ„å°‡ç”± JS å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
                
                <!-- ä¸»è¦æ“ä½œæŒ‰éˆ• -->
                <div class="flex flex-wrap gap-4 mt-6">
                    <button id="add-filter-btn" class="btn-add rounded-xl py-2 px-4 font-medium flex items-center">
                        <span class="text-lg mr-2">âœ¨</span>
                        ï¼‹ æ–°å¢æ¢ä»¶
                    </button>
                    <button id="clear-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-xl transition duration-300">
                        æ¸…é™¤å…¨éƒ¨
                    </button>
                    <button id="filter-button" class="btn-upload rounded-xl py-2 px-6 font-bold ml-auto">
                        å¥—ç”¨ç¯©é¸
                    </button>
                </div>
            </section>

            <!-- é¡¯ç¤ºè®€å–åˆ°çš„è³‡æ–™ -->
            <section class="mt-6">
                <!-- æ¨™é¡Œ å’Œ åŒ¯å‡ºæŒ‰éˆ• -->
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-800">ğŸ“Š ç¯©é¸çµæœ:</h2>
                    <button id="export-button" class="hidden btn-add rounded-xl py-2 px-4 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="align-middle">åŒ¯å‡º (XLSX)</span>
                    </button>
                </div>

                <!-- æ¢ä»¶æ¨™ç±¤ (Chips) å®¹å™¨ (æ”¹ç‚ºäº®è—è‰²) -->
                <div id="filter-chips-container" class="flex flex-wrap gap-2 mb-4">
                    <!-- ç¯©é¸æ¢ä»¶æ¨™ç±¤å°‡ç”± JS å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>

                <!-- çµæœè¡¨æ ¼ (æ”¹ç‚ºç™½åº•) -->
                <div id="results-output" class="w-full h-96 bg-white text-gray-800 text-sm p-4 rounded-md overflow-auto border border-gray-200 shadow-inner">
                    è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥...
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        // -------------------------------------------------------------------------
        // (*** æ–°å¢ ***) éƒ¨ç½²åˆ° GitHub Pages çš„é‡è¦æé†’ï¼š
// ... existing code ... -->
        // 6. å¦‚æœä¸åŸ·è¡Œæ­¥é©Ÿ 5ï¼ŒGoogle ç™»å…¥å°‡æœƒå› ç‚º 'auth/unauthorized-domain' éŒ¯èª¤è€Œå¤±æ•—ã€‚
        // -------------------------------------------------------------------------


        // (*** ä¿®æ”¹ ***) è¼‰å…¥ v9 æ¨¡çµ„åŒ–å‡½å¼ (åŒ…å« Google Auth)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { 
            getAuth, 
// ... existing code ... -->
            signOut
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
// ... existing code ... -->
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // (*** ä¿®æ­£ ***) å°‡æ‰€æœ‰å•Ÿå‹•ä»£ç¢¼ç§»è‡³ DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {

            // (*** ä¿®æ”¹ ***) ç™»å…¥ç›¸é—œ DOM å…ƒç´  (ç§»é™¤å¯†ç¢¼ï¼Œæ–°å¢ Google)
            const loginContainerEl = document.getElementById('login-container');
// ... existing code ... -->
            const filterChipsContainerEl = document.getElementById('filter-chips-container');

            // å…¨åŸŸè®Šæ•¸å„²å­˜è³‡æ–™
            let allHeaders = [];
// ... existing code ... -->
            let activeFilters = []; // å„²å­˜ç•¶å‰å¥—ç”¨çš„ç¯©é¸æ¢ä»¶

            // Firebase å…¨åŸŸè®Šæ•¸
            let app, db, auth;
// ... existing code ... -->
            let unsubscribeData = null; // ç”¨æ–¼å–æ¶ˆç›£è½

            // æ‚¨æä¾›çš„ Firebase è¨­å®š
            const firebaseConfig = {
// ... existing code ... -->
                measurementId: "G-GMLSW66F6F"
            };

            // (ä¿®æ”¹) ç™»å…¥ç‹€æ…‹
            let currentUserRole = null;
            
// ... existing code ... -->
             * åŒ¯å‡ºçµæœ (XLSX)
             */
            function exportResults() {
// ... existing code ... -->
                }
            }

            // (*** ä¿®æ­£ ***) å°‡äº‹ä»¶ç›£è½å’Œå•Ÿå‹•å‡½å¼ç§»è‡³æ­¤è™•
            
            // ç¶å®šæª”æ¡ˆä¸Šå‚³äº‹ä»¶
            if (fileInputEl) {
                fileInputEl.addEventListener('change', handleFile);
            }

            // å¹«æŒ‰éˆ•ç¶å®šäº‹ä»¶
            if (filterButtonEl) {
                filterButtonEl.addEventListener('click', applyFilter);
            }
            if (exportButtonEl) {
                exportButtonEl.addEventListener('click', exportResults);
            }
            // --- ç¶å®šæ–°æŒ‰éˆ• ---
            if (addFilterBtnEl) {
                addFilterBtnEl.addEventListener('click', () => addFilterGroup());
            }
            if (clearFiltersBtnEl) {
                clearFiltersBtnEl.addEventListener('click', () => clearAllFilters(true));
            }
            // (*** æ–°å¢ ***) Google ç™»å…¥äº‹ä»¶ç›£è½
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', signInWithGoogle);
            }
            // (*** ä¿®æ”¹ ***) ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ç›£è½
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (auth) {
                        await signOut(auth); // è§¸ç™¼ onAuthStateChanged
                    }
                });
            }

            // (*** æ–°å¢ ***) å•Ÿå‹• Firebase åˆå§‹åŒ–
            initializeAppAndAuth();
        
        }); // <-- çµæŸ DOMContentLoaded

    </script>

</body>
</html>

